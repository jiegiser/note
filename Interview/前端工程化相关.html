<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模块化 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/note/assets/css/0.styles.12c78510.css" as="style"><link rel="preload" href="/note/assets/js/app.5f30b128.js" as="script"><link rel="preload" href="/note/assets/js/2.bfd5325d.js" as="script"><link rel="preload" href="/note/assets/js/29.21d37a62.js" as="script"><link rel="preload" href="/note/assets/js/72.8b48baa3.js" as="script"><link rel="prefetch" href="/note/assets/js/10.0e80f02e.js"><link rel="prefetch" href="/note/assets/js/100.abff1e60.js"><link rel="prefetch" href="/note/assets/js/101.a72d862c.js"><link rel="prefetch" href="/note/assets/js/102.fcee016e.js"><link rel="prefetch" href="/note/assets/js/103.41ecfa9d.js"><link rel="prefetch" href="/note/assets/js/104.88bdc157.js"><link rel="prefetch" href="/note/assets/js/105.fe3fa11b.js"><link rel="prefetch" href="/note/assets/js/106.9ba83b61.js"><link rel="prefetch" href="/note/assets/js/107.2540df8e.js"><link rel="prefetch" href="/note/assets/js/108.db5d95b1.js"><link rel="prefetch" href="/note/assets/js/109.0dfa6098.js"><link rel="prefetch" href="/note/assets/js/11.0872041e.js"><link rel="prefetch" href="/note/assets/js/110.6762c8c8.js"><link rel="prefetch" href="/note/assets/js/111.9296c4b6.js"><link rel="prefetch" href="/note/assets/js/112.fb4fa725.js"><link rel="prefetch" href="/note/assets/js/113.e36812ca.js"><link rel="prefetch" href="/note/assets/js/114.7f84c78f.js"><link rel="prefetch" href="/note/assets/js/115.e9fcd4e1.js"><link rel="prefetch" href="/note/assets/js/116.e829bd4f.js"><link rel="prefetch" href="/note/assets/js/117.cc27d9d7.js"><link rel="prefetch" href="/note/assets/js/118.ac64d1d6.js"><link rel="prefetch" href="/note/assets/js/119.b9095572.js"><link rel="prefetch" href="/note/assets/js/12.923e92f3.js"><link rel="prefetch" href="/note/assets/js/120.e6e04b71.js"><link rel="prefetch" href="/note/assets/js/121.042e272f.js"><link rel="prefetch" href="/note/assets/js/122.42eee8d4.js"><link rel="prefetch" href="/note/assets/js/123.a1e85c36.js"><link rel="prefetch" href="/note/assets/js/124.14a5aca5.js"><link rel="prefetch" href="/note/assets/js/125.521072ee.js"><link rel="prefetch" href="/note/assets/js/126.7a80b4bc.js"><link rel="prefetch" href="/note/assets/js/127.5b85438d.js"><link rel="prefetch" href="/note/assets/js/128.fa15b8e4.js"><link rel="prefetch" href="/note/assets/js/129.cb32cb10.js"><link rel="prefetch" href="/note/assets/js/13.8c82174c.js"><link rel="prefetch" href="/note/assets/js/130.acb79e4a.js"><link rel="prefetch" href="/note/assets/js/131.982efb3f.js"><link rel="prefetch" href="/note/assets/js/132.3f06dbb2.js"><link rel="prefetch" href="/note/assets/js/133.2168c1d4.js"><link rel="prefetch" href="/note/assets/js/134.6c00fbbf.js"><link rel="prefetch" href="/note/assets/js/135.594267d4.js"><link rel="prefetch" href="/note/assets/js/136.fefb3e1d.js"><link rel="prefetch" href="/note/assets/js/137.a2f08c6d.js"><link rel="prefetch" href="/note/assets/js/138.29686b5c.js"><link rel="prefetch" href="/note/assets/js/139.0790c0bf.js"><link rel="prefetch" href="/note/assets/js/14.c5e25d26.js"><link rel="prefetch" href="/note/assets/js/140.4107c12b.js"><link rel="prefetch" href="/note/assets/js/141.c6d2fe3b.js"><link rel="prefetch" href="/note/assets/js/142.8742c2a7.js"><link rel="prefetch" href="/note/assets/js/143.f8c67711.js"><link rel="prefetch" href="/note/assets/js/144.f6a56d7c.js"><link rel="prefetch" href="/note/assets/js/145.d986cfcf.js"><link rel="prefetch" href="/note/assets/js/146.8c688d55.js"><link rel="prefetch" href="/note/assets/js/147.9cbea793.js"><link rel="prefetch" href="/note/assets/js/148.24a17e54.js"><link rel="prefetch" href="/note/assets/js/149.5aa4395d.js"><link rel="prefetch" href="/note/assets/js/15.94468999.js"><link rel="prefetch" href="/note/assets/js/150.7a7c91c6.js"><link rel="prefetch" href="/note/assets/js/151.da215993.js"><link rel="prefetch" href="/note/assets/js/152.e972f3b2.js"><link rel="prefetch" href="/note/assets/js/153.fa4eb3ef.js"><link rel="prefetch" href="/note/assets/js/154.45951ea1.js"><link rel="prefetch" href="/note/assets/js/155.361a2131.js"><link rel="prefetch" href="/note/assets/js/156.8c48b4be.js"><link rel="prefetch" href="/note/assets/js/157.62a5ed19.js"><link rel="prefetch" href="/note/assets/js/158.b8b7e1f3.js"><link rel="prefetch" href="/note/assets/js/159.f3bc3488.js"><link rel="prefetch" href="/note/assets/js/16.ca8c5a27.js"><link rel="prefetch" href="/note/assets/js/160.b2a41580.js"><link rel="prefetch" href="/note/assets/js/161.7838dd1d.js"><link rel="prefetch" href="/note/assets/js/162.bc94ff67.js"><link rel="prefetch" href="/note/assets/js/163.c0768380.js"><link rel="prefetch" href="/note/assets/js/164.4a44f4e7.js"><link rel="prefetch" href="/note/assets/js/165.218792c9.js"><link rel="prefetch" href="/note/assets/js/166.2669ba78.js"><link rel="prefetch" href="/note/assets/js/167.1e612b90.js"><link rel="prefetch" href="/note/assets/js/168.1e232142.js"><link rel="prefetch" href="/note/assets/js/169.570590fd.js"><link rel="prefetch" href="/note/assets/js/17.887d70da.js"><link rel="prefetch" href="/note/assets/js/170.e98d59f9.js"><link rel="prefetch" href="/note/assets/js/171.9660680c.js"><link rel="prefetch" href="/note/assets/js/172.6571415c.js"><link rel="prefetch" href="/note/assets/js/173.3d6f7a08.js"><link rel="prefetch" href="/note/assets/js/174.9bd8273b.js"><link rel="prefetch" href="/note/assets/js/175.9bab507a.js"><link rel="prefetch" href="/note/assets/js/176.0c6b7384.js"><link rel="prefetch" href="/note/assets/js/177.279da1e8.js"><link rel="prefetch" href="/note/assets/js/178.0e19edca.js"><link rel="prefetch" href="/note/assets/js/179.fcad1038.js"><link rel="prefetch" href="/note/assets/js/18.523e447e.js"><link rel="prefetch" href="/note/assets/js/180.a1083de9.js"><link rel="prefetch" href="/note/assets/js/181.dfb679fd.js"><link rel="prefetch" href="/note/assets/js/182.6c6a313a.js"><link rel="prefetch" href="/note/assets/js/183.d2c255d5.js"><link rel="prefetch" href="/note/assets/js/184.dd380327.js"><link rel="prefetch" href="/note/assets/js/185.849a961d.js"><link rel="prefetch" href="/note/assets/js/186.2b228da7.js"><link rel="prefetch" href="/note/assets/js/187.fc00f846.js"><link rel="prefetch" href="/note/assets/js/19.3aace9e7.js"><link rel="prefetch" href="/note/assets/js/20.47c5fed8.js"><link rel="prefetch" href="/note/assets/js/21.e5c14222.js"><link rel="prefetch" href="/note/assets/js/22.04bfe5a5.js"><link rel="prefetch" href="/note/assets/js/23.793556aa.js"><link rel="prefetch" href="/note/assets/js/24.7b42eaa1.js"><link rel="prefetch" href="/note/assets/js/25.cb1420b9.js"><link rel="prefetch" href="/note/assets/js/26.e99be95d.js"><link rel="prefetch" href="/note/assets/js/27.dafd01fc.js"><link rel="prefetch" href="/note/assets/js/28.76c07f36.js"><link rel="prefetch" href="/note/assets/js/3.2b1cc5ee.js"><link rel="prefetch" href="/note/assets/js/30.0cf9eba0.js"><link rel="prefetch" href="/note/assets/js/31.beb188e2.js"><link rel="prefetch" href="/note/assets/js/32.d75a6d04.js"><link rel="prefetch" href="/note/assets/js/33.dc8f1c09.js"><link rel="prefetch" href="/note/assets/js/34.0fadcfa2.js"><link rel="prefetch" href="/note/assets/js/35.65b3e8b4.js"><link rel="prefetch" href="/note/assets/js/36.0c624297.js"><link rel="prefetch" href="/note/assets/js/37.afdde6da.js"><link rel="prefetch" href="/note/assets/js/38.d4a78c75.js"><link rel="prefetch" href="/note/assets/js/39.715b4b9b.js"><link rel="prefetch" href="/note/assets/js/4.d109c8dc.js"><link rel="prefetch" href="/note/assets/js/40.18757722.js"><link rel="prefetch" href="/note/assets/js/41.79daf9e4.js"><link rel="prefetch" href="/note/assets/js/42.dfee7ed6.js"><link rel="prefetch" href="/note/assets/js/43.3cd8902b.js"><link rel="prefetch" href="/note/assets/js/44.f11ceac6.js"><link rel="prefetch" href="/note/assets/js/45.1205afaf.js"><link rel="prefetch" href="/note/assets/js/46.f008d887.js"><link rel="prefetch" href="/note/assets/js/47.29dc7226.js"><link rel="prefetch" href="/note/assets/js/48.0e22aacc.js"><link rel="prefetch" href="/note/assets/js/49.7a71fae3.js"><link rel="prefetch" href="/note/assets/js/5.f54ea6dd.js"><link rel="prefetch" href="/note/assets/js/50.2203badb.js"><link rel="prefetch" href="/note/assets/js/51.f1d96f81.js"><link rel="prefetch" href="/note/assets/js/52.54ad650b.js"><link rel="prefetch" href="/note/assets/js/53.cd3b8287.js"><link rel="prefetch" href="/note/assets/js/54.a2147ad2.js"><link rel="prefetch" href="/note/assets/js/55.f3338279.js"><link rel="prefetch" href="/note/assets/js/56.3d9bd1f3.js"><link rel="prefetch" href="/note/assets/js/57.ccc8b097.js"><link rel="prefetch" href="/note/assets/js/58.8c775eb8.js"><link rel="prefetch" href="/note/assets/js/59.51e235ce.js"><link rel="prefetch" href="/note/assets/js/6.f2294a3c.js"><link rel="prefetch" href="/note/assets/js/60.cf73c2fd.js"><link rel="prefetch" href="/note/assets/js/61.91cf0bdb.js"><link rel="prefetch" href="/note/assets/js/62.aaad31a3.js"><link rel="prefetch" href="/note/assets/js/63.59eafe1f.js"><link rel="prefetch" href="/note/assets/js/64.76d01e44.js"><link rel="prefetch" href="/note/assets/js/65.cd63178f.js"><link rel="prefetch" href="/note/assets/js/66.3d7c2ad4.js"><link rel="prefetch" href="/note/assets/js/67.d74851d4.js"><link rel="prefetch" href="/note/assets/js/68.443118b0.js"><link rel="prefetch" href="/note/assets/js/69.6e7603bd.js"><link rel="prefetch" href="/note/assets/js/7.9f047235.js"><link rel="prefetch" href="/note/assets/js/70.a1acdcdb.js"><link rel="prefetch" href="/note/assets/js/71.2dc8fd6f.js"><link rel="prefetch" href="/note/assets/js/73.6358d7ad.js"><link rel="prefetch" href="/note/assets/js/74.e14f45f8.js"><link rel="prefetch" href="/note/assets/js/75.3e0d5b7e.js"><link rel="prefetch" href="/note/assets/js/76.4572dd7d.js"><link rel="prefetch" href="/note/assets/js/77.51ac3773.js"><link rel="prefetch" href="/note/assets/js/78.15027c45.js"><link rel="prefetch" href="/note/assets/js/79.d7d6e1f3.js"><link rel="prefetch" href="/note/assets/js/8.12881ada.js"><link rel="prefetch" href="/note/assets/js/80.6fc12724.js"><link rel="prefetch" href="/note/assets/js/81.10c11c71.js"><link rel="prefetch" href="/note/assets/js/82.82e94675.js"><link rel="prefetch" href="/note/assets/js/83.99fa6a0f.js"><link rel="prefetch" href="/note/assets/js/84.30acd353.js"><link rel="prefetch" href="/note/assets/js/85.75d469a5.js"><link rel="prefetch" href="/note/assets/js/86.8aaa49fa.js"><link rel="prefetch" href="/note/assets/js/87.6bb77eb0.js"><link rel="prefetch" href="/note/assets/js/88.b903afa0.js"><link rel="prefetch" href="/note/assets/js/89.8f98da72.js"><link rel="prefetch" href="/note/assets/js/9.b37c6d7c.js"><link rel="prefetch" href="/note/assets/js/90.58963f28.js"><link rel="prefetch" href="/note/assets/js/91.fcfa145c.js"><link rel="prefetch" href="/note/assets/js/92.9e729c74.js"><link rel="prefetch" href="/note/assets/js/93.bc12e45e.js"><link rel="prefetch" href="/note/assets/js/94.e31b24e3.js"><link rel="prefetch" href="/note/assets/js/95.f1962ded.js"><link rel="prefetch" href="/note/assets/js/96.f5ee3bda.js"><link rel="prefetch" href="/note/assets/js/97.ef9301d2.js"><link rel="prefetch" href="/note/assets/js/98.1149dd77.js"><link rel="prefetch" href="/note/assets/js/99.93de9837.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.12c78510.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h2> <p>模块化发展主要经历了三个阶段：</p> <ul><li>早期利用 JavaScript 特性实现的模块化阶段</li> <li>规范化标准时代</li> <li>ES 原生时代</li></ul> <h3 id="早期利用-javascript-特性实现的模块化阶段"><a href="#早期利用-javascript-特性实现的模块化阶段" class="header-anchor">#</a> 早期利用 JavaScript 特性实现的模块化阶段</h3> <p>利用自执行函数以及闭包，结合顶层 window 对象实现如下代码：</p> <p>首先通过立即执行函数，构造一个私有作用域，再通过闭包，将需要对外暴露的数据个接口输出。
通过给自执行函数传递参数，可以达到两个模块的相互依赖。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">window<span class="token punctuation">,</span> $</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">'data'</span>

  fuction <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  window<span class="token punctuation">.</span>module <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> jQuery<span class="token punctuation">)</span>
</code></pre></div><h3 id="规范化标准时代-commonjs"><a href="#规范化标准时代-commonjs" class="header-anchor">#</a> 规范化标准时代: CommonJS</h3> <p>NodeJS 在前端的发展具有极大的促进作用，它带来的 CommonJS 模块化规范；在 NodeJS 中，每个文件就是一个模块，具有单独的作用域，对其他文件是不可见的。CommonJS 有以下几个容易被忽略的特点：</p> <ul><li>文件即模块，文件内的所有代码都运行在独立的作用域中，因此不会污染全局空间。</li> <li>模块可以被多次引用、加载。在第一次被加载时，会被缓存，之后都从缓存中直接读取结果。</li> <li>加载某个模块，就是引入该模块的 module.exports 属性。</li> <li>module.exports 输出输出的是值的拷贝，一旦这个值被输出，模块内再发生变化也不会影响到输出的值。</li> <li>模块按照代码引入的顺序进行加载。</li> <li>注意 module.exports 和 exports 的区别。</li></ul> <p>CommonJS 规范如何用代码在浏览器端实现呢？其实就是实现 module.exports 和 require 方法。</p> <p>实现思路：通过 require 的文件路径加载文件内容并执行，同时将对外接口进行缓存。因此我们需要定义一个 module 对象，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>然后借助立即执行函数，对 module 和 module.exports 对象进行赋值，如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span>
</code></pre></div><h3 id="规范化标准时代-amd"><a href="#规范化标准时代-amd" class="header-anchor">#</a> 规范化标准时代：AMD</h3> <p>由于 nodeJS 运行与服务器上，所有的文件一般都已经存储在本地硬盘中了，不需要额外的网络请求进行异步加载，因此通过 CommonJS 规范加载模块是同步的。只有加载完成，才能执行后续操作。但是，如果 NodeJS 在浏览器环境中运行，那么由于需要从服务器端获取模块文件，所以此时采用同步的方式显然是不合适的，为此，社区推出了 AMD 规范。</p> <p>AMD 规范定义了如何定义模块，如何对外输出，如何引入依赖。这一切都需要代码去实现，因此一个出现一个 require.js 库。它实现很简单：通过 define 方法，将代码定义为模块；通过 require 方法，实现代码的模块加载。</p> <p>define 和 require 就是 require.js 在全局注入的函数。</p> <p>事实上，require.js 也是借助一个立即执行函数来实现的，其中的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> require<span class="token punctuation">,</span> <span class="token function">define</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> setTimeout</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> setTimeout <span class="token operator">===</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> setTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>define 方法的具体实现逻辑如下：主要用于将依赖注入依赖队列</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">define</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span>defQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> callback<span class="token punctuation">]</span><span class="token punctuation">)</span>
    context<span class="token punctuation">.</span>defQueueMap<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    globalDefQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>name<span class="token punctuation">,</span> deps<span class="token punctuation">,</span> callback<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>require 的主要作用是完成 script 标签的创建去请求响应的模块，并对模块进行加载和执行，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这是简易的require.js</span>

<span class="token comment">/**
 * @descrition 实现js的加载
 * @param arr  js的路径数组
 * @param callback 当所有的js都加载完后的回调函数
 * @date 2018-09-13
 * @Author Yike
*/</span>
<span class="token comment">// 导出方法的简陋实现</span>
window<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>arr <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;arr is not a Array&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// REQ_TOTAL  标记已加载成功个数</span>
	<span class="token comment">// EXP_ARR    记录各个模块的顺序</span>
	<span class="token comment">// REQLEN     定义共需要加载多少个js</span>
	<span class="token keyword">var</span> <span class="token constant">REQ_TOTAL</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token constant">EXP_ARR</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token constant">REQLEN</span> <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
		
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req_item<span class="token punctuation">,</span>index<span class="token punctuation">,</span>arr</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// 创建script的标签并放到页面中</span>
		<span class="token keyword">var</span> $script <span class="token operator">=</span> <span class="token function">createScript</span><span class="token punctuation">(</span>req_item<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
		document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>$script<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">$script</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">//检测script的onload事件</span>
			$script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token constant">REQ_TOTAL</span><span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">var</span> script_index <span class="token operator">=</span> $script<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 把导出对象放到数组中</span>
				<span class="token constant">EXP_ARR</span><span class="token punctuation">[</span>script_index<span class="token punctuation">]</span> <span class="token operator">=</span> exports<span class="token punctuation">;</span>
				<span class="token comment">// 重置对象</span>
				window<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

				<span class="token comment">//所有js加载成功后，执行callback函数。</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">REQ_TOTAL</span> <span class="token operator">==</span> <span class="token constant">REQLEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token constant">EXP_ARR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>$script<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//创建一个script标签</span>
<span class="token keyword">function</span> <span class="token function">createScript</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> $s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	$s<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>
	$s<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> $s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>有人会发现，在我们使用 require.js 后，并没有发现额外多出来的 script 标签。这是因为 checkLoaded 方法会把已经加载完毕的脚本删除，因为我们需要的是模块内容，就没有必要保留 script 标签了。删除 script 标签的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">removeScript</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">each</span><span class="token punctuation">(</span><span class="token function">script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">scriptNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>scriptNode<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-requiremodule'</span><span class="token punctuation">)</span> <span class="token operator">===</span> name <span class="token operator">&amp;&amp;</span> scriptNode<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-requirecontext'</span><span class="token punctuation">)</span> <span class="token operator">===</span> context<span class="token punctuation">.</span>contextName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scriptNode<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>scriptNode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="规范化标准时代-cmd"><a href="#规范化标准时代-cmd" class="header-anchor">#</a> 规范化标准时代：CMD</h3> <p>CMD 规范整合了 CommonJS 和 AMD 规范的特定，与 require.js 类似，CMD 规范的实现为 sea.js。</p> <p>AMD 和 CMD 的另两个主要区别如下：</p> <ul><li>AMD 需要异步加载模块，而 CMD 在加载模块时，可以通过同步的方式 (require)，也可以通过异步的方式 (require.async)；</li> <li>CMD 遵循依赖就近原则，AMD 遵循依赖前置原则。也就是说，在 AMD 中，我们需要把模块所需要的依赖都提前声明在依赖数组中；而在 CMD 中，我们只需要在具体代码逻辑内，使用依赖前，引入依赖的模块即可。</li></ul> <h3 id="规范化标准时代-umd"><a href="#规范化标准时代-umd" class="header-anchor">#</a> 规范化标准时代：UMD</h3> <p>他允许在环境中同时使用 AMD 规范和 CommonJS 规范，相当于一个整合的规范。该规范的核心思想在于利用立即执行函数根据环境来判断需要的参数类别，譬如，UMD 在判断出当前模块遵循 CommonJS 规范时，模块化代码会以如下方式执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而 UMD 判断出当前模块遵循 AMD 规范，则函数的参数就会变成 define，适用 AMD 规范，具体代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AMD 规范</span>
    <span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 类 Node 环境，并不支持完全严格的 CommonJS 规范</span>
    <span class="token comment">// 但是属于 CommonJS-like 环境，支持 module.exports 用法</span>
    module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 浏览器环境</span>
    root<span class="token punctuation">.</span>returnExports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回值作为暴露内容</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="es-原生时代"><a href="#es-原生时代" class="header-anchor">#</a> ES 原生时代</h3> <p>ES 模块的设计思想是尽量静态化，这样能保证在编译时就确定模块之间的依赖关系，每个模块的输入和输出变量也都是确定的；而 CommonJS 和 AMD 模块无法保证在编译时就确定这些内容，他们都只能在运行时确定。这是 ES 模块和其他模块规范最显著的差别。第二个差别在于，CommonJS 模块输出的是一个值的拷贝，ES 模块输出的是值的引用。</p> <h4 id="es-模块为何要设计成静态的"><a href="#es-模块为何要设计成静态的" class="header-anchor">#</a> ES 模块为何要设计成静态的</h4> <p>将 ES 设计成静态的，一个明显的优势是，通过静态分析，我们能够分析出导入的依赖。如果导入的模块没有被使用，我们便可以通过 tree shaking 等手段减少代码体积。进而提升运行性能。</p> <p>从设计角度分析这种规范的利弊。静态性需要规范去强制保证，因此 ES 模块规范不像 CommonJS 规范那样灵活，其静态性会带来如下一些限制：</p> <ul><li>只能在文件顶部引入依赖</li> <li>导出的变量类型受到严格限制</li> <li>变量不允许被重新绑定，引入的模块名只能是字符串常量，即不可以动态确定依赖。</li></ul> <p>这样的限定在语言层面带来的便利之一是，我们可以通过分析作用域，得出代码中变量所属的作用域及他们之间的引用关系，进而可以推导出变量和导入依赖变量之间的引用关系。在没有明显引用时，可以对代码进行去冗余。</p> <h4 id="tree-shaking"><a href="#tree-shaking" class="header-anchor">#</a> tree shaking</h4> <p>上面说到：在没有明显引用时，可以对代码进行去冗余，就是我们经常提到的 tree shaking。他的目的是减少应用中没有被实际运用的 JavaScript 代码。对无用代码进行清除，得到更小的代码体积。</p> <p>tree shaking 存在一些局限，比如 rollup 的 tree shaking 只能处理函数和顶层的 import/export 导入的变量，不能把没用到的类的方法清除；具有副作用的脚本无法被清除。</p> <h4 id="es-的-export-和-export-default"><a href="#es-的-export-和-export-default" class="header-anchor">#</a> ES 的 export 和 export default</h4> <p>建议减少使用 export default 导出，一方面是因为 export default 会导出整体对象结果，不利于通过 tree shaking 进行分析；另一方面是因为 export default 导出的结果可以随意命名变量，不利于团队统一管理。</p> <h4 id="在浏览器中快速使用-es-模块化"><a href="#在浏览器中快速使用-es-模块化" class="header-anchor">#</a> 在浏览器中快速使用 ES 模块化</h4> <p>可以在 script 标签上加一个 <code>type=&quot;module&quot;</code> 属性。通过该属性，浏览器就知道这个文件是以模块化的方式运行的。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> module1 <span class="token keyword">from</span> <span class="token string">'./module1'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">nomodule</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'你的浏览器不支持 ES 模块！请先升级'</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="webpack"><a href="#webpack" class="header-anchor">#</a> webpack</h2> <h3 id="webpack-编译结果"><a href="#webpack-编译结果" class="header-anchor">#</a> webpack 编译结果</h3> <h4 id="commonjs-规范下的打包结果"><a href="#commonjs-规范下的打包结果" class="header-anchor">#</a> CommonJS 规范下的打包结果</h4> <ul><li>webpack 打包结果就是一个立即执行函数，一般被称为 webpackBootstrap，这个 IIFE 接收一个对象 modules 作为参数，modules 对象的 key 是依赖路径，value 是经过简单处理后的脚本（他不完全等同于我们编写的业务脚本，而是被 webpack 包裹后的内容）。</li> <li>打包结果中定义了一个重要的模块加载函数 <code>__webpack_require_</code>。</li> <li>首先使用模块加载函数 <code>__webpack_require_</code> 去加载入口模块 <code>./src/index.js</code>。</li> <li>加载函数 <code>__webpack_require_</code> 使用了闭包变量 installedModules，他的作用是将已加载过的模块结果保存在内存中。</li></ul> <h4 id="es-规范下的打包结果"><a href="#es-规范下的打包结果" class="header-anchor">#</a> ES 规范下的打包结果</h4> <p>打包后的结果多了以下语句：</p> <div class="language-js extra-class"><pre class="language-js"><code>__webpack_require__<span class="token punctuation">.</span><span class="token function">r</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">)</span>
</code></pre></div><p>实际上 <code>__webpack_require__.r</code> 这个方法时用来给模块的 exports 对象加上 ES 模块化规范的标记的。</p> <p>具体标记方式为：如果当前环境支持 Symbol 对象，则可以通过 Object.defindProperty 为 exports 对象的 Symbol.toStringTag 属性赋值 Module，这样做的结果是 exports 对象在调用 toString 方法时会返回 Module，同时将 exports.__esModule 赋值为 true。</p> <h3 id="webpack-工作原理"><a href="#webpack-工作原理" class="header-anchor">#</a> webpack 工作原理</h3> <p>webpack 工作流程如下图：</p> <p><img src="/note/assets/img/webpack.cf61bbf6.jpg" alt="avatar"></p> <p>简单总结起来，流程大概如下：</p> <ul><li><p>首先, webpack 会读取项目中由开发者定义的 webpack.config.js 配置文件，或者从 shell 语句中获得必要的参数。这是 webpack 内部接收业务配置信息的方式。这样就完成了配置读取的初步工作。</p></li> <li><p>接着，将所需的 webpack 插件实例化，在 webpack 事件流上挂载插件钩子，这样在合适的构建过程中，插件就具备了改动产出结果的能力。</p></li> <li><p>同时，根据配置所定义的入口文件，从入口文件(可以不止一个)开始，进行依赖收集，对所有依赖的文件进行编译，这个编译过程依赖 loaders，不同类型的文件根据开发者定义的不同 loader 进行解析。编译好的内容使用 acom 或其他抽象语法树能力，解析生成抽象语法树，分析文件依赖关系，将不同模块化语法(如 require)等替换为 <code>__webpack_require__</code>，即使用 webpack 自己的加载器进行模块化实现。</p></li> <li><p>上述步骤完成后，产出结果，根据开发者配置，将结果打包到相应目录。</p></li></ul> <p>在整个打包过程中，webpack 和插件都采用基于事件流的发布/订阅模式，监听某些关键过程，并在这些环节中执行插件任务。最后，所有文件的编译和转化都已经完成，输出最终资源。</p> <p>模块会经历加载 (loaded)、封装（sealed）、优化（optimized）、分块（chunked）、哈希（hashed）和重新创建（restored）这几个经典步骤。</p> <h3 id="抽象语法树"><a href="#抽象语法树" class="header-anchor">#</a> 抽象语法树</h3> <p>抽象语法树是源码语法结构的一种抽象表达。他以树状的形式表现编程语言的语法结构，树上的每个节点都表示源码中的一种结构和表达。AST 并不会被计算机所识别，更不会被运行，他是对编程语言的一种表达，为代码分析提供了基础。</p> <p>webpack 将文件转换为 AST 的目的就是方便开发者提取模块文件中的关键信息。这样依赖，我们就可以知晓开发者到底写了什么东西，也就可以根据这些写出的东西进行分析和扩展。在代码层面，我们可以把 AST 理解为一个 object，比如下面代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ast <span class="token operator">=</span> <span class="token string">'demo'</span>
</code></pre></div><p>转换为 AST 后的代码：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Program&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
  <span class="token property">&quot;body&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclaration&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      <span class="token property">&quot;declarations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;VariableDeclaration&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
          <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
            <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ast&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;init&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Literal&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
          <span class="token property">&quot;end&quot;</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
          <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token string">&quot;demo&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;raw&quot;</span><span class="token operator">:</span> <span class="token string">&quot;'demo'&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;var&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sourceType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面数据表明了这是一条变量声明语句，语句起始于哪里、赋值结果是什么等信息都被表达出来。</p> <h3 id="compiler-和-compilation"><a href="#compiler-和-compilation" class="header-anchor">#</a> compiler 和 compilation</h3> <p>compiler 和 compilation 是 webpack 的核心，也是理解 webpack 工作原理、loader 和插件工作的基础</p> <ul><li><p>compiler 对象：他的实例包含了完整的 webpack 配置，且全局只有一个 compiler 实例，因此他就像 webpack 的骨架或神经中枢。当插件被实例化的时候，就会收到一个 compiler 对象，通过这对象可以访问 webpack 的内部环境。</p></li> <li><p>compilation 对象：当 webpack 以开发模式运行时，每当监测到文件变化时，一个新的 compilation 对象就会被创建。这个对象包含了当前的模块资源、编译生成的资源、变化的文件等信息。也就是说，所有构件过程中产生的构建数据都会被存储到该对象上，他也掌控这构建过程中的每一个环节。该对象还提供了很多事件回调供插件做扩展。</p></li></ul> <p><img src="/note/assets/img/compiler.2b11d156.jpg" alt="avatar"></p> <p>wepack 的构件过程是通过 compiler 控制流程的，通过 compilation 进行代码解析的。在开发插件时，我们可以从 compiler 对象中得到所有与 webpack 主环境相关的内容，包括时间钩子。</p> <p>compiler 对象和 compilation 对象都继承自 tapable 库，该库暴露了所有和事件相关的发布/订阅的方法。webpack 中基于事件流的 tapable 库不仅能保证插件的有序性，还能使整个系统扩展性更好。</p> <h3 id="编写-webpack-loader"><a href="#编写-webpack-loader" class="header-anchor">#</a> 编写 webpack loader</h3> <p>loader 就是接受源文件，对源文件进行处理，并返回编译后的文件。比如解析 less 文件，配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.less</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'style-loader'</span> <span class="token comment">// 通过 JavaScript 字符串创建 style node</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'css-loader'</span> <span class="token comment">//  编译 css 使其符合 commonjs 规范</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">'less-loader'</span> <span class="token comment">// 将 less 编译为 css</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>串联调用多个 loader 去转换一个文件时，loader 执行顺序如下：</p> <ul><li>loader 的执行顺序和配置顺序是相反的，即配置的最后一个 loader 最先执行；也就是从下往上执行。</li> <li>第一个执行的 loader 接收源文件中的内容作为参数，其他 loader 接收前一个执行的 loader 的返回值作为参数。</li></ul> <p>在开发的时候，只需要关心输入和输出，但需要注意报纸其职责的单一性，loader 本质上就是一个函数，其最简单的结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">return</span> content
<span class="token punctuation">}</span>
</code></pre></div><p>loader 就是一个基于 CommonJS 规范的函数模块。在编写 loader 时，除了编写 source 内容，还需要根据开发者配置的 options 信息进行构建定制化处理，以输出最后的结果。需要用到 loader-utils 模块：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取开发者配置的 options</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token comment">// some magic...</span>
  <span class="token keyword">return</span> content
<span class="token punctuation">}</span>

</code></pre></div><p>单纯对 content 进行改写并返回改写后的内容也许是不够的。比如，我们向对 loader 处理过程中的错误进行捕获，或者想导出 soureMap 等信息时，可以通过 loader 中的 this.callback 来返回内容。this.callback 中可以传入 4 个参数，分别入下：</p> <ul><li>error：当 loader 出错时向外抛出一个 error。</li> <li>content：经过 loader 编译后需要导出的内容。</li> <li>sourceMap：为方便调试编译后的 source map；</li> <li>ast：本次编译生成的抽象语法树。之后执行的 loader 可以直接使用这个 ast，省去重复生成的过程。</li></ul> <p>下面的代码可以获取开发者传入的配置信息，并根据信息作出处理：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取开发者配置的 options</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token comment">// some magic</span>
  <span class="token comment">// return content</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>注意，当使用 this.callback 返回内容时，该 loader 必须返回 undefined，这样 webpack 就知道该 loader 返回耳朵结果在 this.callback 中，而不再 return 中。</p> <p>还有一个要注意的是，这里的 this。他执向的是一个叫 loaderContext 的 loader-runner 特有的对象。</p> <p>默认情况下，webpack 传给 loader 的内容源都是 UTF-8 格式编码的字符串。但 file-loader 这个常用的 laoder 不是处理文本文件的，而是处理二进制文件的，在这种情况下，可以通过 source instanceof Buffer === true 来判断内容源类型，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  source <span class="token keyword">instanceof</span> <span class="token class-name">Buffer</span> <span class="token operator">===</span> <span class="token boolean">true</span>
  <span class="token keyword">return</span> source
<span class="token punctuation">}</span>
</code></pre></div><p>如果自定义的 laoder 也会返回二进制文件，则需要在文件中显式注明，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><p>当然还存在使用异步 loader 的情况，这时可以使用简单的 async await 即可，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">retsolve</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另一种异步 loader 的解决方案是使用 webpack 提供的 this.async，调用 this.async 会返回一个回调函数，可以在异步操作完成后进行调用，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">retsolve</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面编写一个 path-replace-loader，这个 loader 将允许把 require 语句中的 base path 替换为动态指定的 path，使用和配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      loader<span class="token operator">:</span> <span class="token string">'path-replace-loader'</span><span class="token punctuation">,</span>
      exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'OGIGINAL_PATH'</span><span class="token punctuation">,</span>
        replacePath<span class="token operator">:</span> <span class="token string">'REPLACE_PATH'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>编写 path-replace-loader：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> loaderUtils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>cacheable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newPath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>path<span class="token punctuation">,</span> options<span class="token punctuation">.</span>replacePath<span class="token punctuation">)</span>

    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>newPath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'ENOENT'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 将新文件加入 webpack 依赖中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>newPath<span class="token punctuation">)</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>expors<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre></div><h3 id="编写-webpack-plugin"><a href="#编写-webpack-plugin" class="header-anchor">#</a> 编写 webpack plugin</h3> <p>我们前面提到 webpack 的事件流机制，该机制是说，在 webpack 构建的声明周期中，webpack 会广播许多事件。在该机制下，开发者注册的各种插件可以根据需要监听与自身相关的事件。插件捕获事件后，可以在合适的时机通过 webpack 提供的 API 去改变编译输出结果。</p> <p>webpack loader 和 webpack plugin 的差异如下：</p> <ul><li>loader 其实就是一个转化器，执行单纯的文件转换操作。</li> <li>plugin 是一个扩展器，他丰富了 webpack 本身，在 loader 中的操作执行结束后，webpack 进行打包时，webpack plugin 并不直接操作文件，而是基于事件机制工作，监听 webpack 打包过程中的某些事件，见缝插针，进行修改打包结果。</li></ul> <p>我们需要知道 webpack 打包有哪些钩子事件，结合我们需要开发的 plugin 需要做什么才能完成一个 plugin 开发，可以查看官网有哪些钩子函数：
https://webpack.docschina.org/api/compiler-hooks/#root；</p> <p>我们知道，compiler 对象暴露了和 webpack 整个生命周期相关的钩子，可以通过如下代码对相关钩子进行访问：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 基本写法</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>someHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>例如，如果希望 webpack 在读取 entry 配置后就执行某项工作，就可以使用下面代码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>下面是在生成的资源输出之前执行某个功能，则可以通过下面的代码来实现：</p> <div class="language-js extra-class"><pre class="language-js"><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><p>一个自定义 webpack plugin 的骨架结果就是一个带有 apply 方法的类，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相关钩子的注册回调</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>someHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// magic here</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 打印出此时 compiler 对象暴露的钩子</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> hook <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>compiler 除了暴露于 webpack 整体构建声明周期相关的钩子，还暴露了与模块和依赖相关的、粒度更细的钩子。可以查看官网的 compilation 暴露的所有事件钩子。</p> <p>使用 compilation 相关钩子的通用写法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相关钩子的注册回调</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>someOtherHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'SomePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// some magic here</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 打印出此时 compiler 对象暴露的钩子</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> hook <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CustomPlugin

</code></pre></div><p>总结一下编写 plugin 的套路：</p> <ul><li><p>定义一个 JavaScript class 函数，或在函数原型 (property) 中定义一个以 compiler 对象为参数的 apply 方法。</p></li> <li><p>在 apply 方法中通过 compiler 插入指定的事件钩子，并在钩子回调中获取 compilation 对象。</p></li> <li><p>使用 compilation 修改 webpack 打包的内容。</p></li></ul> <p>plugin 中也存在异步操作的情况，比如一些事件钩子所执行的就是异步操作。相应地，我们可以使用 tapAsync 和 tapPromise 方法来处理异步操作，如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CustomPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options
  <span class="token punctuation">}</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 相关钩子的注册回调</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'CustomPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">asyncFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CustomPlugin

</code></pre></div><p>下面我们开发一个类似 react 开发项目的时候一旦出现错误，就会出现 error overlay 提示。代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ErrorOverlayPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  devtool<span class="token operator">:</span> <span class="token string">'cheap-module-source-map'</span><span class="token punctuation">,</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ErrorOverlayPlugin 就是我们需要开发 plugin，我们借助 errorOverlayMiddleware 中间件来进行错误拦截并展示，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> errorOverlayMiddleware <span class="token keyword">from</span> <span class="token string">'react-dev-utils/errorOverlayMiddleware'</span>

<span class="token keyword">class</span> <span class="token class-name">ErrorOverlayPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> className <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name
    <span class="token keyword">if</span> <span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>mode <span class="token operator">!==</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>entryOption<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> chunkPath <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./entry'</span><span class="token punctuation">)</span>
      <span class="token function">adjustEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> chunkPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterResolvers<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> options <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> originalBefore <span class="token operator">=</span> options<span class="token punctuation">.</span>devServer<span class="token punctuation">.</span>before
        option<span class="token punctuation">.</span>devServer<span class="token punctuation">.</span><span class="token function-variable function">begfore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> server</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>originalBefore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">originalBefore</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> server<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
          app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">errorOverlayMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">adjustEntry</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> chunkPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>chunkPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>chunkPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entryName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      entry<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">adjustEntry</span><span class="token punctuation">(</span>entry<span class="token punctuation">[</span>entryName<span class="token punctuation">]</span><span class="token punctuation">,</span> chunkPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ErrorOverlayPlugin
</code></pre></div><p>webpack 的事件机制基于 tapable 库。</p> <h2 id="webpack-和-rollup"><a href="#webpack-和-rollup" class="header-anchor">#</a> webpack 和 Rollup</h2> <p>Rollup 的功能特点如下：</p> <ul><li>依赖解析，打包构建</li> <li>仅支持 ES Next 模块</li> <li>内置支持 tree shaking 功能</li></ul> <p>对于两者的定位可以总结一句话：建库用 Rollup，其他场景用 webpack。因为使用 webpack 打包会生成比较多的冗余代码，这对于业务代码来说没什么问题，能保证较强的程序健壮性和语法还原度，同时有利于保障兼容性。也许开发者会关心代码量多带来的冗余问题，但衡量其优缺点和开发效率方面的性价比，webpack 始终是业务开发的首选；但对于库来说就不一样了，对相同的脚本进行打包，如果运用 Rollup，则复杂的模块冗余就会完全消失。Rollup 通过将代码顺序引入同一个文件俩解决模块依赖问题，因此通过 Rollup 来做拆包就会出现问题，原因是模块完全透明了。在复杂应用中，我们往往需要进行拆包，而在库的编写中很少用到这样的功能，因此使用 Rollup 对库进行打包是没有问题的。</p> <p>webpack 全局变量的注册，可以通过 DefinePlugin 这个 webpack 的内置插件在 webpack 编译阶段进行。</p> <p>使用 sax.js 可以解析 wxml（xml 风格）文件。他是解析 XML 和 HTML 的基础库。</p> <h2 id="代码规范工具"><a href="#代码规范工具" class="header-anchor">#</a> 代码规范工具</h2> <ul><li>prettier：美化代码，在项目根目录创建 prettier.config.js 文件进行添加 prettier 规则，以及结合编辑器可以设置保存时对代码格式化；</li> <li>eslint：代码检查工具，在项目根目录创建 .eslintrc 配置文件，进行配置规则。每个规则其对应的数组第一项有三个可选项； off/0、warn/1、error/2，分别表示关闭规则、以 warning 形式打开规则、以 error 形式打开规则。</li></ul> <section style="border-top:2px solid #eaecef;padding-top:1rem;margin-top:2rem;"><div><span data-flag-title="Your Article Title" class="leancloud-visitors"><em class="post-meta-item-text">阅读量： </em> <i class="leancloud-visitors-count"></i></span></div> <h3><a href="javascript:;"></a>
    评 论：
  </h3> <div id="vcomments"></div></section></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新:</span> <span class="time">3/15/2021, 6:19:01 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/note/assets/js/app.5f30b128.js" defer></script><script src="/note/assets/js/2.bfd5325d.js" defer></script><script src="/note/assets/js/29.21d37a62.js" defer></script><script src="/note/assets/js/72.8b48baa3.js" defer></script>
  </body>
</html>
