<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能监控和错误收集与上报 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/note/assets/css/0.styles.747e5b72.css" as="style"><link rel="preload" href="/note/assets/js/app.cf3e5064.js" as="script"><link rel="preload" href="/note/assets/js/2.bfd5325d.js" as="script"><link rel="preload" href="/note/assets/js/43.5187dca8.js" as="script"><link rel="prefetch" href="/note/assets/js/10.5b570012.js"><link rel="prefetch" href="/note/assets/js/100.abff1e60.js"><link rel="prefetch" href="/note/assets/js/101.f660807a.js"><link rel="prefetch" href="/note/assets/js/102.4be025c2.js"><link rel="prefetch" href="/note/assets/js/103.80751001.js"><link rel="prefetch" href="/note/assets/js/104.c43e1876.js"><link rel="prefetch" href="/note/assets/js/105.fe3fa11b.js"><link rel="prefetch" href="/note/assets/js/106.f9c1e1e3.js"><link rel="prefetch" href="/note/assets/js/107.e8c81c17.js"><link rel="prefetch" href="/note/assets/js/108.d359af3a.js"><link rel="prefetch" href="/note/assets/js/109.a1c55d4f.js"><link rel="prefetch" href="/note/assets/js/11.6f02981e.js"><link rel="prefetch" href="/note/assets/js/110.6762c8c8.js"><link rel="prefetch" href="/note/assets/js/111.63b121ff.js"><link rel="prefetch" href="/note/assets/js/112.8326a98e.js"><link rel="prefetch" href="/note/assets/js/113.1edf66c2.js"><link rel="prefetch" href="/note/assets/js/114.ec216974.js"><link rel="prefetch" href="/note/assets/js/115.4270d4a6.js"><link rel="prefetch" href="/note/assets/js/116.743dfd44.js"><link rel="prefetch" href="/note/assets/js/117.cc27d9d7.js"><link rel="prefetch" href="/note/assets/js/118.ac64d1d6.js"><link rel="prefetch" href="/note/assets/js/119.0656c733.js"><link rel="prefetch" href="/note/assets/js/12.923e92f3.js"><link rel="prefetch" href="/note/assets/js/120.0eb2138d.js"><link rel="prefetch" href="/note/assets/js/121.042e272f.js"><link rel="prefetch" href="/note/assets/js/122.98e4aa07.js"><link rel="prefetch" href="/note/assets/js/123.dbc3ed9f.js"><link rel="prefetch" href="/note/assets/js/124.c955db94.js"><link rel="prefetch" href="/note/assets/js/125.521072ee.js"><link rel="prefetch" href="/note/assets/js/126.7a80b4bc.js"><link rel="prefetch" href="/note/assets/js/127.5b85438d.js"><link rel="prefetch" href="/note/assets/js/128.fa15b8e4.js"><link rel="prefetch" href="/note/assets/js/129.5f9a58f0.js"><link rel="prefetch" href="/note/assets/js/13.8c82174c.js"><link rel="prefetch" href="/note/assets/js/130.acb79e4a.js"><link rel="prefetch" href="/note/assets/js/131.1e665b20.js"><link rel="prefetch" href="/note/assets/js/132.3f06dbb2.js"><link rel="prefetch" href="/note/assets/js/133.b9c8ccd6.js"><link rel="prefetch" href="/note/assets/js/134.47501964.js"><link rel="prefetch" href="/note/assets/js/135.594267d4.js"><link rel="prefetch" href="/note/assets/js/136.fefb3e1d.js"><link rel="prefetch" href="/note/assets/js/137.d4877c2a.js"><link rel="prefetch" href="/note/assets/js/138.29686b5c.js"><link rel="prefetch" href="/note/assets/js/139.0790c0bf.js"><link rel="prefetch" href="/note/assets/js/14.94ac989e.js"><link rel="prefetch" href="/note/assets/js/140.4107c12b.js"><link rel="prefetch" href="/note/assets/js/141.c6d2fe3b.js"><link rel="prefetch" href="/note/assets/js/142.8742c2a7.js"><link rel="prefetch" href="/note/assets/js/143.f8c67711.js"><link rel="prefetch" href="/note/assets/js/144.f6a56d7c.js"><link rel="prefetch" href="/note/assets/js/145.d986cfcf.js"><link rel="prefetch" href="/note/assets/js/146.cda26ec4.js"><link rel="prefetch" href="/note/assets/js/147.fbaf09b3.js"><link rel="prefetch" href="/note/assets/js/148.24a17e54.js"><link rel="prefetch" href="/note/assets/js/149.5aa4395d.js"><link rel="prefetch" href="/note/assets/js/15.64e08857.js"><link rel="prefetch" href="/note/assets/js/150.b1a02410.js"><link rel="prefetch" href="/note/assets/js/151.da215993.js"><link rel="prefetch" href="/note/assets/js/152.a058bb87.js"><link rel="prefetch" href="/note/assets/js/153.163e5828.js"><link rel="prefetch" href="/note/assets/js/154.f98e9fc9.js"><link rel="prefetch" href="/note/assets/js/155.2daf69c5.js"><link rel="prefetch" href="/note/assets/js/156.0e244f81.js"><link rel="prefetch" href="/note/assets/js/157.bad7f892.js"><link rel="prefetch" href="/note/assets/js/158.f036d261.js"><link rel="prefetch" href="/note/assets/js/159.d0a4a509.js"><link rel="prefetch" href="/note/assets/js/16.01613856.js"><link rel="prefetch" href="/note/assets/js/160.8062db90.js"><link rel="prefetch" href="/note/assets/js/161.79e18696.js"><link rel="prefetch" href="/note/assets/js/162.bc94ff67.js"><link rel="prefetch" href="/note/assets/js/163.c0768380.js"><link rel="prefetch" href="/note/assets/js/164.c709e7fe.js"><link rel="prefetch" href="/note/assets/js/165.643eee0f.js"><link rel="prefetch" href="/note/assets/js/166.c7a2158f.js"><link rel="prefetch" href="/note/assets/js/167.b4eb4b44.js"><link rel="prefetch" href="/note/assets/js/168.2347d827.js"><link rel="prefetch" href="/note/assets/js/169.e4fd4d1c.js"><link rel="prefetch" href="/note/assets/js/17.3a3a17bd.js"><link rel="prefetch" href="/note/assets/js/170.4aba72db.js"><link rel="prefetch" href="/note/assets/js/171.f02e5a8b.js"><link rel="prefetch" href="/note/assets/js/172.6571415c.js"><link rel="prefetch" href="/note/assets/js/173.95b0908a.js"><link rel="prefetch" href="/note/assets/js/174.12005dea.js"><link rel="prefetch" href="/note/assets/js/175.9bab507a.js"><link rel="prefetch" href="/note/assets/js/176.0c6b7384.js"><link rel="prefetch" href="/note/assets/js/177.bb8069cc.js"><link rel="prefetch" href="/note/assets/js/178.a72546b4.js"><link rel="prefetch" href="/note/assets/js/179.b7e8c5b0.js"><link rel="prefetch" href="/note/assets/js/18.523e447e.js"><link rel="prefetch" href="/note/assets/js/180.a1083de9.js"><link rel="prefetch" href="/note/assets/js/181.dfb679fd.js"><link rel="prefetch" href="/note/assets/js/182.38258cdd.js"><link rel="prefetch" href="/note/assets/js/183.d2c255d5.js"><link rel="prefetch" href="/note/assets/js/184.85111a7a.js"><link rel="prefetch" href="/note/assets/js/185.849a961d.js"><link rel="prefetch" href="/note/assets/js/186.2b228da7.js"><link rel="prefetch" href="/note/assets/js/187.fc00f846.js"><link rel="prefetch" href="/note/assets/js/19.3aace9e7.js"><link rel="prefetch" href="/note/assets/js/20.47c5fed8.js"><link rel="prefetch" href="/note/assets/js/21.a3a950f4.js"><link rel="prefetch" href="/note/assets/js/22.b173613b.js"><link rel="prefetch" href="/note/assets/js/23.793556aa.js"><link rel="prefetch" href="/note/assets/js/24.a7179974.js"><link rel="prefetch" href="/note/assets/js/25.0172ba4b.js"><link rel="prefetch" href="/note/assets/js/26.29d78bab.js"><link rel="prefetch" href="/note/assets/js/27.e828d7aa.js"><link rel="prefetch" href="/note/assets/js/28.76c07f36.js"><link rel="prefetch" href="/note/assets/js/29.21d37a62.js"><link rel="prefetch" href="/note/assets/js/3.2f8c4349.js"><link rel="prefetch" href="/note/assets/js/30.a71629ca.js"><link rel="prefetch" href="/note/assets/js/31.5406b7e7.js"><link rel="prefetch" href="/note/assets/js/32.34ad0e3f.js"><link rel="prefetch" href="/note/assets/js/33.59711af3.js"><link rel="prefetch" href="/note/assets/js/34.23a2bc54.js"><link rel="prefetch" href="/note/assets/js/35.870b8ef7.js"><link rel="prefetch" href="/note/assets/js/36.0c624297.js"><link rel="prefetch" href="/note/assets/js/37.afdde6da.js"><link rel="prefetch" href="/note/assets/js/38.d4a78c75.js"><link rel="prefetch" href="/note/assets/js/39.052ee3ae.js"><link rel="prefetch" href="/note/assets/js/4.12a10528.js"><link rel="prefetch" href="/note/assets/js/40.18757722.js"><link rel="prefetch" href="/note/assets/js/41.2e4f15f2.js"><link rel="prefetch" href="/note/assets/js/42.63cea5ec.js"><link rel="prefetch" href="/note/assets/js/44.58cb40cb.js"><link rel="prefetch" href="/note/assets/js/45.1205afaf.js"><link rel="prefetch" href="/note/assets/js/46.54dc8625.js"><link rel="prefetch" href="/note/assets/js/47.aa364922.js"><link rel="prefetch" href="/note/assets/js/48.4e333104.js"><link rel="prefetch" href="/note/assets/js/49.431de4d8.js"><link rel="prefetch" href="/note/assets/js/5.b877f58b.js"><link rel="prefetch" href="/note/assets/js/50.cee7b6f3.js"><link rel="prefetch" href="/note/assets/js/51.f8b65632.js"><link rel="prefetch" href="/note/assets/js/52.2bb9e3ed.js"><link rel="prefetch" href="/note/assets/js/53.cd3b8287.js"><link rel="prefetch" href="/note/assets/js/54.553a0071.js"><link rel="prefetch" href="/note/assets/js/55.f3338279.js"><link rel="prefetch" href="/note/assets/js/56.9f066da7.js"><link rel="prefetch" href="/note/assets/js/57.ccc8b097.js"><link rel="prefetch" href="/note/assets/js/58.4581bacf.js"><link rel="prefetch" href="/note/assets/js/59.4d096266.js"><link rel="prefetch" href="/note/assets/js/6.b5c9cb4a.js"><link rel="prefetch" href="/note/assets/js/60.af34f739.js"><link rel="prefetch" href="/note/assets/js/61.af3b0215.js"><link rel="prefetch" href="/note/assets/js/62.ce9c89b2.js"><link rel="prefetch" href="/note/assets/js/63.2b8bdcbb.js"><link rel="prefetch" href="/note/assets/js/64.d969ba5b.js"><link rel="prefetch" href="/note/assets/js/65.015afe58.js"><link rel="prefetch" href="/note/assets/js/66.42134bd7.js"><link rel="prefetch" href="/note/assets/js/67.07301389.js"><link rel="prefetch" href="/note/assets/js/68.443118b0.js"><link rel="prefetch" href="/note/assets/js/69.b9ad84be.js"><link rel="prefetch" href="/note/assets/js/7.634707c5.js"><link rel="prefetch" href="/note/assets/js/70.567a2f00.js"><link rel="prefetch" href="/note/assets/js/71.2dc8fd6f.js"><link rel="prefetch" href="/note/assets/js/72.8b48baa3.js"><link rel="prefetch" href="/note/assets/js/73.6358d7ad.js"><link rel="prefetch" href="/note/assets/js/74.e14f45f8.js"><link rel="prefetch" href="/note/assets/js/75.76fc6e70.js"><link rel="prefetch" href="/note/assets/js/76.b570111b.js"><link rel="prefetch" href="/note/assets/js/77.f1dd74e8.js"><link rel="prefetch" href="/note/assets/js/78.15027c45.js"><link rel="prefetch" href="/note/assets/js/79.d7d6e1f3.js"><link rel="prefetch" href="/note/assets/js/8.7ccf6894.js"><link rel="prefetch" href="/note/assets/js/80.6fc12724.js"><link rel="prefetch" href="/note/assets/js/81.10c11c71.js"><link rel="prefetch" href="/note/assets/js/82.82e94675.js"><link rel="prefetch" href="/note/assets/js/83.99fa6a0f.js"><link rel="prefetch" href="/note/assets/js/84.30acd353.js"><link rel="prefetch" href="/note/assets/js/85.ca05377d.js"><link rel="prefetch" href="/note/assets/js/86.39411dc5.js"><link rel="prefetch" href="/note/assets/js/87.220e7702.js"><link rel="prefetch" href="/note/assets/js/88.9abd6b14.js"><link rel="prefetch" href="/note/assets/js/89.c56cb90d.js"><link rel="prefetch" href="/note/assets/js/9.b37c6d7c.js"><link rel="prefetch" href="/note/assets/js/90.44b2562f.js"><link rel="prefetch" href="/note/assets/js/91.fcfa145c.js"><link rel="prefetch" href="/note/assets/js/92.9e729c74.js"><link rel="prefetch" href="/note/assets/js/93.bc12e45e.js"><link rel="prefetch" href="/note/assets/js/94.e31b24e3.js"><link rel="prefetch" href="/note/assets/js/95.f1962ded.js"><link rel="prefetch" href="/note/assets/js/96.f5ee3bda.js"><link rel="prefetch" href="/note/assets/js/97.ef9301d2.js"><link rel="prefetch" href="/note/assets/js/98.1149dd77.js"><link rel="prefetch" href="/note/assets/js/99.93de9837.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.747e5b72.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="性能监控和错误收集与上报"><a href="#性能监控和错误收集与上报" class="header-anchor">#</a> 性能监控和错误收集与上报</h2> <h3 id="性能监控指标"><a href="#性能监控指标" class="header-anchor">#</a> 性能监控指标</h3> <p>常用指标有首次绘制(FP)时间、首次有内容绘制(FCP)时间、首次有意义绘制(FMP)时间、首屏时间、用户可交互(TT)时间。接下来分别看一看每个指标的含义。</p> <ul><li>首次绘制时间：对于应用页面，首次出现视党上不同于跳转之前内容的时间点，或者说是页面发生第一次绘制的时间点。</li> <li>首次有内容绘制时间：指浏览器完成渲染 DOM 中第一部分内容(可能是文本、图像或其他任何元素)的时间点，此时用户应该在视觉上有直观的感受。</li> <li>首次有意义绘制时间：指页面关键元素的渲染时间。这个概念并没有标准化定义，因为关键元素可以由开发者自行定义究竟什么是“有意义”的内容，只有开发者或产品经理自己了解。</li> <li>首屏时间：对于所有网页应用，这是一个非常重要的指标。用大白话来说，就是进入页面之后，应用渲染完成整个手机屏幕(未滚动之前)内容的时间。需要注意的是，业界对于这个指标其实没有确切的定论，比如，这个时间是否包含手机屏幕内图片的渲染完成时间。</li> <li>用户可交互时间：顾名思义，就是用户可以与应用进行交互的时间。一般来讲，我们认为是 Domready 的时间，因为我们通常会在这时绑定事件操作。如果页面中涉及交互的脚本没有下载完成，那么当然没有到达所谓的用户可交互时间。</li></ul> <p>这里提一下，DOMContentLoaded 与 load 事件的区别。DOMContentLoaded 指的是文档中 DOM 内容加载完毕的时间，也就是说 HTML 结构已经是完整的了。很多页面都包含图片、特殊字体、视频等其他资源，由于这些资源由网络请求获取，需要额外的网络请求；当页面所有的资源加载完毕后，load 事件才会被触发。</p> <h3 id="性能数据获取"><a href="#性能数据获取" class="header-anchor">#</a> 性能数据获取</h3> <h4 id="window-performance-强大但有缺点"><a href="#window-performance-强大但有缺点" class="header-anchor">#</a> window.performance：强大但有缺点</h4> <p>该 API 不仅能计算出页面性能相关的数据，还能计算出于页面资源加载和异步请求相关的数据。</p> <p>调用 performance.timing 会返回一个对象，这个对象包含各种页面加载和渲染的时间细节，如下：</p> <p><img src="/note/assets/img/performance.e7a2c4a8.png" alt="avatar"></p> <p>我们可以通过对上图中的信息进行计算得到以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> window<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token punctuation">{</span> 
    memory<span class="token operator">:</span> <span class="token punctuation">{</span>
        usedJSHeapSize<span class="token punctuation">,</span>
        totalJSHeapSize<span class="token punctuation">,</span>
        jsHeapSizeLimit
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
 
    navigation<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 页面重定向跳转到当前页面的次数</span>
        redirectCount<span class="token punctuation">,</span>
        <span class="token comment">// 以哪种方式进入页面</span>
        <span class="token comment">// 0 正常跳转进入</span>
        <span class="token comment">// 1 window.location.reload() 重新刷新</span>
        <span class="token comment">// 2 通过浏览器历史记录，以及前进后退进入</span>
        <span class="token comment">// 255 其他方式进入</span>
        type<span class="token punctuation">,</span>         
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
 
    timing<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等于前一个页面 unload 时间，如果没有前一个页面，则等于 fetchStart 时间</span>
        navigationStart<span class="token punctuation">,</span>
        <span class="token comment">// 前一个页面 unload 时间，如果没有前一个页面或者前一个页面与当前页面不同域，则值为 0</span>
        unloadEventStart<span class="token punctuation">,</span>
        <span class="token comment">// 前一个页面 unload 事件绑定的回调函数执行完毕的时间</span>
        unloadEventEnd<span class="token punctuation">,</span>
        redirectStart<span class="token punctuation">,</span>
        redirectEnd<span class="token punctuation">,</span>
        <span class="token comment">// 检查缓存前，准备请求第一个资源的时间</span>
        fetchStart<span class="token punctuation">,</span>
        <span class="token comment">// 域名查询开始的时间</span>
        domainLookupStart<span class="token punctuation">,</span>
        <span class="token comment">// 域名查询结束的时间</span>
        domainLookupEnd<span class="token punctuation">,</span>
        <span class="token comment">// HTTP（TCP） 开始建立连接的时间	        connectStart,</span>
        <span class="token comment">// HTTP（TCP）建立连接结束的时间</span>
        connectEnd<span class="token punctuation">,</span>
        secureConnectionStart<span class="token punctuation">,</span>
        <span class="token comment">// 连接建立完成后，请求文档开始的时间</span>
        requestStart<span class="token punctuation">,</span>
        <span class="token comment">// 连接建立完成后，文档开始返回并收到内容的时间</span>
        responseStart<span class="token punctuation">,</span>
        <span class="token comment">// 最后一个字节返回并收到内容的时间</span>
        responseEnd<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 loading 的时间</span>
        domLoading<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 interactive</span>
        domInteractive<span class="token punctuation">,</span>
        <span class="token comment">// DOMContentLoaded 事件开始时间</span>
        domContentLoadedEventStart<span class="token punctuation">,</span>
        <span class="token comment">// DOMContentLoaded 事件结束时间</span>
        domContentLoadedEventEnd<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 complete 的时间	        domComplete,</span>
        <span class="token comment">// load 事件开始的时间</span>
        loadEventStart<span class="token punctuation">,</span>
        <span class="token comment">// load 事件结束的时间</span>
        loadEventEnd
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据这些时间节点选择对应的时间两两做差，便可以计算出一些典型的指标，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">calcTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing
      
    <span class="token comment">// 重定向时间</span>
    times<span class="token punctuation">.</span>redirectTime <span class="token operator">=</span> t<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>redirectStart
      
    <span class="token comment">// DNS 查询耗时</span>
    times<span class="token punctuation">.</span>dnsTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>domainLookupStart
      
    <span class="token comment">// TCP 建立连接完成握手的时间</span>
    connect <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
      
    <span class="token comment">// TTFB 读取页面第一个字节的时间</span>
    times<span class="token punctuation">.</span>ttfbTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart
      
    <span class="token comment">// DNS 缓存时间</span>
    times<span class="token punctuation">.</span>appcacheTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupStart <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// 卸载页面的时间</span>
    times<span class="token punctuation">.</span>unloadTime <span class="token operator">=</span> t<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>unloadEventStart
      
    <span class="token comment">// TCP 连接耗时</span>
    times<span class="token punctuation">.</span>tcpTime <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
      
    <span class="token comment">// request 请求耗时</span>
    times<span class="token punctuation">.</span>reqTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>responseStart
      
    <span class="token comment">// 解析 DOM 树耗时</span>
    times<span class="token punctuation">.</span>analysisTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> t<span class="token punctuation">.</span>domInteractive
      
    <span class="token comment">// 白屏时间</span>
    times<span class="token punctuation">.</span>blankTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// domReadyTime 即用户可交互时间</span>
    times<span class="token punctuation">.</span>domReadyTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domContentLoadedEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// 用户等待页面完全可用的时间</span>
    times<span class="token punctuation">.</span>loadPage <span class="token operator">=</span> t<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart

    <span class="token keyword">return</span> times
<span class="token punctuation">}</span>
</code></pre></div><p>该 API 也有不适应的场景，比如在单页应用中改变 URL 但不刷新页面（单页面引用的典型路由分格方案），那么使用该 API 所获取的数据是不会更新的，还需要开发者重新设计统计方案。</p> <h4 id="自定义事件计算"><a href="#自定义事件计算" class="header-anchor">#</a> 自定义事件计算</h4> <p>对于网页高度小于屏幕的网站来说，统计首屏渲染耗时非常简单，只要在页面底部加上脚本，记录执行该脚本的时间，并将这个时间与 window.performance.timing.navigationStart 时间做差，即得到首屏渲染耗时。</p> <p>对于网页高度大于一屏的页面来说，需要先估算出接近于一个屏幕的最后一个元素的位置，然后在该位置插入下面的脚本：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
</code></pre></div><p>上面的计算方式显然是理想化的，这种方式其实并没有考虑首屏图片加载的情况，也就是说对于首屏图片未加载完的情况，我们也认为加载已经完成。如果需要考虑首屏图片的架子啊，需要使用集中化脚本统计首屏时间。通过使用定时器不断检测 img 节点，判断图片是否在首屏加载完成，找到首屏加载最慢的图片加载完成的时间，从而计算出首屏时间；如果首屏没有图片，那就使用 DOMReady 时间。计算首屏渲染耗时的相关代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getOffsetTop</span> <span class="token operator">=</span> <span class="token parameter">ele</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> offsetTop <span class="token operator">=</span> ele<span class="token punctuation">.</span>offsetTop
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>offsetParent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offsetTop <span class="token operator">+=</span> <span class="token function">getOffsetTop</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span>offsetParent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> offsetTop
<span class="token punctuation">}</span>

<span class="token keyword">const</span> win <span class="token operator">=</span> window
<span class="token keyword">const</span> firstScreenHeight <span class="token operator">=</span> win<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height
<span class="token keyword">let</span> firstScreenImgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> isFindLastImg <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> allImgLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> collect <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> img
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFindLastImg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstScreenImgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> firstScreenImgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                img <span class="token operator">=</span> firstScreenImgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>img<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    allImgLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allImgLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            collect<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                firstScreenLoaded<span class="token operator">:</span> startTime <span class="token operator">-</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">clearInterval</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> imgs <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            img <span class="token operator">=</span> imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">let</span> imgOffsetTop <span class="token operator">=</span> <span class="token function">getOffsetTop</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imgOffsetTop <span class="token operator">&gt;</span> firstScreenHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imgOffsetTop <span class="token operator">&lt;=</span> firstScreenHeight 
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>img<span class="token punctuation">.</span>hasPushed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                img<span class="token punctuation">.</span>hasPushed <span class="token operator">=</span> <span class="token number">1</span>
                firstScreenImgs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> doc <span class="token operator">=</span> document
doc<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

win<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
    isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>另外一种方式是不适用定时器，且默认影响首屏时间的主要因素是图片的加载，如果没有图片，那么纯粹渲染文字是很快的，因此，可以通过统计首屏内图片的加载时间获取首屏渲染完成的时间，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">logFirstScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> iLen <span class="token operator">=</span> images<span class="token punctuation">.</span>length
    <span class="token keyword">let</span> curMax <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> inScreenLen <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment">// 图片的加载回调</span>
    <span class="token keyword">function</span> <span class="token function">imageBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>removeEventListener
        <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> imageBack<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>curMax <span class="token operator">===</span> inScreenLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 所有在首屏的图片均已加载完成的话，发送日志</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span> 
    <span class="token comment">// 对于所有的位于指定区域的图片，绑定回调事件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> s <span class="token operator">&lt;</span> iLen<span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> img <span class="token operator">=</span> images<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
        <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token punctuation">{</span>
            top<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> curImg <span class="token operator">=</span> img
        <span class="token keyword">while</span> <span class="token punctuation">(</span>curImg<span class="token punctuation">.</span>offsetParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            offset<span class="token punctuation">.</span>top <span class="token operator">+=</span> curImg<span class="token punctuation">.</span>offsetTop
            curImg <span class="token operator">=</span> curImg<span class="token punctuation">.</span>offsetParent
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断图片在不在首屏</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">&lt;</span> offset<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 图片还没有加载完成的话</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>img<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inScreenLen<span class="token operator">++</span>
            img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> imageBack<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果首屏没有图片的话，直接发送日志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inScreenLen <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送日志进行统计</span>
    <span class="token keyword">function</span> <span class="token function">log</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>logInfo<span class="token punctuation">.</span>firstScreen <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'首屏时间：'</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="错误信息收集"><a href="#错误信息收集" class="header-anchor">#</a> 错误信息收集</h3> <h4 id="try-catch-方案"><a href="#try-catch-方案" class="header-anchor">#</a> try catch 方案</h4> <p>就是给每个函数进行包裹该语法，可以手动，也可以使用自动化工具，如 foio 实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">isASTFunctionNode</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Defun</span> <span class="token operator">||</span> node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Function</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">globalFuncTryCatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">inputCode<span class="token punctuation">,</span> errorHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token string">'errorHandler should be a valid function'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> errorHandlerSource <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> errorHandlerAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> errorHandlerSource <span class="token operator">+</span> <span class="token string">')(error);'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tryCatchAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'try{}catch(error){}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> inputAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>inputCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> topFuncScope <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//将错误处理函数包裹进入catch中</span>
    tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bcatch<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> errorHandlerAST<span class="token punctuation">;</span>

    <span class="token comment">//搜集所有函数</span>
    <span class="token keyword">var</span> walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeWalker</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isASTFunctionNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            topFuncScope<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputAST<span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>walker<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//对函数进行变换, 添加try catch语句</span>
    <span class="token keyword">var</span> transfer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeTransformer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isASTFunctionNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>topFuncScope<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//函数内部代码搜集</span>
                <span class="token keyword">var</span> stream <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">OutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">var</span> innerFuncCode <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//清除try catch中定义的多余语句</span>
                tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//用try catch包裹函数代码</span>
                <span class="token keyword">var</span> innerTyrCatchNode <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>innerFuncCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>toplevel<span class="token operator">:</span> tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//获取函数壳</span>
                node<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//生成有try catch的函数</span>
                <span class="token keyword">return</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>innerTyrCatchNode<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>toplevel<span class="token operator">:</span> node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputAST<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> outputCode <span class="token operator">=</span> inputAST<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">{</span>beautify<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> outputCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>globalFuncTryCatch <span class="token operator">=</span> globalFuncTryCatch<span class="token punctuation">;</span>
</code></pre></div><p>当静态资源服务器可以添加 Access-Control-Allow-Origin: * 时，我们可以直接使用 window.onError 进行全局异常捕获；当静态资源服务器不受控制，window.onError失效，我们可以借助 AST 技术，自动化地对全部目标 Javascript 函数添加 try catch 来捕获所有异常。</p> <h4 id="try-catch-方案的局限性"><a href="#try-catch-方案的局限性" class="header-anchor">#</a> try catch 方案的局限性</h4> <p>无法处理语法错误和异步错误。如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  a <span class="token comment">// 未定义变量</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 上面代码可以捕获异常，如改为下面的语法错误就不会捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> \ <span class="token string">'a'</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 下面异步操作无法捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果在 setTimeout 中再加一个 try catch 就可以捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      a
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="window-onerror"><a href="#window-onerror" class="header-anchor">#</a> window.onerror</h4> <p>我们只需要给 window 添加 onerror 事件监听，同时注意将 window.onerror 放在所有脚本之前，便能对语法异常和运行异常进行处理，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>参数具体说明：</p> <ul><li>message：错误信息提示</li> <li>souce：错误脚本地址</li> <li>lineno：错误代码所在行号</li> <li>colno：错误代码所在列号</li> <li>error：错误的对象信息</li></ul> <p>windoe.onerror 除了对语法错误和网络错误（因为网络请求异常不会发生事件冒泡）无能为力，对异步和非异步错误都能捕获到运行时错误。</p> <p>需要注意的是，如果想用 window.onerror 函数消化错误，则需要显示返回 true，以保证错误不会向上抛出，控制台也不会出现一堆错误提示信息。</p> <h4 id="跨域脚本错误处理"><a href="#跨域脚本错误处理" class="header-anchor">#</a> 跨域脚本错误处理</h4> <p>对于不同域的 JavaScript 文件，window.onerror 不能保证获取到有效信息。出于安全原因，不同浏览器返回的错误信息参数可能并不一致。比如，跨域之后，window.onerror 在很多浏览器中是无法获取异常信息的，要统一返回脚本错误（script error），就需要对脚本进行如下设置：</p> <div class="language-js extra-class"><pre class="language-js"><code>crossorigin <span class="token operator">=</span> <span class="token string">&quot;anonymous&quot;</span>
</code></pre></div><p>同时需要在服务器端添加 Access-Control-Allow-Origin Header 内容以指定允许哪些域的请求访问。</p> <h4 id="使用-source-map-进行错误还原"><a href="#使用-source-map-进行错误还原" class="header-anchor">#</a> 使用 source map 进行错误还原</h4> <p>如果代码被压缩报错。可以启用 source map，比如在 webpack 中开启 source map 功能，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  devtool<span class="token operator">:</span> <span class="token string">'#source-map'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="promise-的错误收集与处理"><a href="#promise-的错误收集与处理" class="header-anchor">#</a> Promise 的错误收集与处理</h4> <p>Promise 主要通过 catch 进行捕获异常。可以通过 ESLint 插件 eslint-plugin-promise 插件；他会通过 catch-or-return 来保障代码中所有的 Promise 都有相应的 catch 处理。</p> <p>可能大家会想到，Promise 实例的 then 方法中的第二个 onRejected 函数也能处理错误，跟前面的 catch 有什么差别，如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'catch'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码输出 rejected，在有 onRejected 的情况下，onRejected 就会发挥作用，catch 不会被调用。</p> <p>而执行下面代码时，onRejected 并不能捕获 then 方法第一个参数 onResolved 函数中的错误：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'catch'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Error</span>
    <span class="token comment">// at &lt;anonymous&gt;:4:9 &quot;catch&quot;</span>
</code></pre></div><p>除此之外，在对 Promise 进行错误处理时，还可以捕获事件 unhandledrejection，并在此事件中集中进行错误收集，如下代码：</p> <blockquote><p>unhandledrejection: 当 Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件；这可能发生在 window 下，但也可能发生在 Worker 中。 这对于调试回退错误处理非常有用。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejectioin'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="处理网络加载问题"><a href="#处理网络加载问题" class="header-anchor">#</a> 处理网络加载问题</h4> <p>通过 script、link 标签加载脚本或者其他资源，可以通过下面代码进行异常捕获：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>***.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>errorHandler(this)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>***.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>errorHandler(this)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>除此之外，还可以使用 window.addEventListener('error') 方式对加载异常信息处理。注意，这时无法使用 window.onerror 进行处理，因为 window.onerror 事件通过事件冒泡获取 error 信息的，而网络加载错误是不会进行事件冒泡的。</p> <p>不支持冒泡的事件还有鼠标聚焦/失焦（focus/blur）、与鼠标移动相关的事件（mouseleave/mouseenter）、一些 UI 事件（如 scroll、resize 等）。</p> <p>window.addEventListener('error') 他是通过事件捕获获取 error 信息的，从而对网络资源的加载异常进行处理的。</p> <p>如果区分网络资源加载错误和一般错误，普通错误的 error 对象中会有一个 error.message 属性，表示错误信息，而资源加载错误对应的 error 对象却没有，因此可以根据以下代码进行区分：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 网络资源加载错误</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>window.onerror 如果多次进行函数赋值，后面赋值的会替换之前的值。window.addEventListener('error') 可以绑定多个回调函数，按照绑定顺序依次执行。</p> <h4 id="页面崩溃收集和处理"><a href="#页面崩溃收集和处理" class="header-anchor">#</a> 页面崩溃收集和处理</h4> <p>可以通过监听 window 对象的 load 和 beforeunload 事件，并结合 sessionStorage 对网页崩溃实时监控：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 捕获到页面崩溃</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码很简单，首先在网页加载 load 事件中设置 good_exit 状态。在页面无异常退出前，也就是 beforeunload 中设置为 true，如果该值不是 true 就会判断出页面崩溃，并进行处理。</p> <p>如果应用中部署了 PWA，这里可以通过 service worker 来完成网页崩溃的处理工作。基本原理是，service worker 和网页的主线程是相互独立的。因此即便网页发生了崩溃现象，也不会影响 service worker 所在线程的工作。我们在监控网页的状态时，是通过 navigator.serviceWorker.controller.postMessage API 来进行信息的获取和记录的。</p> <h4 id="框架的错误处理"><a href="#框架的错误处理" class="header-anchor">#</a> 框架的错误处理</h4> <p>React 在 16 版本之后使用 componentDidCatch 来处理错误，vue 中提供了 Vue.config.errorHandler 来处理捕获到的错误。如果开发者没有配置，那么捕获到的错误会以 console.error 的方式输出。因此可以劫持 console.error 来捕获框架中的错误并作出处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nativeConsoleError <span class="token operator">=</span> window<span class="token punctuation">.</span>console<span class="token punctuation">.</span>error
window<span class="token punctuation">.</span>console<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nativeConsoleError</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'I got ${args}'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="性能数据和错误信息上报"><a href="#性能数据和错误信息上报" class="header-anchor">#</a> 性能数据和错误信息上报</h3> <p>上报采用单独域名，这样做有以下好处</p> <ul><li>使用单独域名，可以防止对业务服务器造成压力，，能够避免日志相关处理逻辑和数据主业为服务器上的堆积。</li> <li>另外，很多浏览器对同一域名的请求量有并发数的限制，单独户域名能够充分利用现代浏览器的并发设置。</li></ul> <p>对于独立域名的跨域问题，我们经常发现页面使用构造空的 Image 对象的方式进行数据上报，原因是请求图片并不涉及跨域的问题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> url
</code></pre></div><p>我们可以将数据进行序列化，作为 URL 参数进行传递，代码入下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">xxx?data=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> url
</code></pre></div><p>对于何时上报数据，页面加载性能数据可以在页面稳定后进行上报，对于其他错误和异常数据的上报，我们可以将日志进行合并，在同一时间统一上报。下面列出在什么场景下上报性能数据：</p> <ul><li>页面加载和重新刷新</li> <li>页面切换路由</li> <li>页面所在的 Tab 标签重新变的可见</li> <li>页面关闭</li></ul> <p>对于单页面应用就不一样了。</p> <h4 id="单应用上报"><a href="#单应用上报" class="header-anchor">#</a> 单应用上报</h4> <p>如果切换路由是通过 hash 值来实现的，那么只需要监听 hashchange 事件；如果是 history，那么需要使用 pushState 和 replaceState 事件。当然一劳永逸的做法就是打补丁，并结合发布/订阅模式为相关事件的触发添加处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">patchMethod</span> <span class="token operator">=</span> <span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> historyp<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
  <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
  event<span class="token punctuation">.</span>arguments <span class="token operator">=</span> arguments
  window<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

history<span class="token punctuation">.</span>pushState <span class="token operator">=</span> <span class="token function">patchMethod</span><span class="token punctuation">(</span><span class="token string">'pushState'</span><span class="token punctuation">)</span>
history<span class="token punctuation">.</span>replaceState <span class="token operator">=</span> <span class="token function">patchMethod</span><span class="token punctuation">(</span><span class="token string">'replaceState'</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码重写 history.pushState 和 history.replaceState 方法，添加并触发 pushState 和 replaceState 事件，可以在 history.pushState 和 history.replaceState 事件触发时添加订阅函数并进行上报：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'replaceState'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// report..</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pushState'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// report...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="非单应用上报"><a href="#非单应用上报" class="header-anchor">#</a> 非单应用上报</h4> <p>如果在页面离开时进行数据发送，那么页面卸载期间能否安全地发送完数据就是一个难题，因为在页面跳转，进入下一个页面，难以保证异步数据的安全发送。如果使用同步的 AJAX 方法，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">logData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'/log'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 第三个参数各行业表明 XHR 是同步的</span>
  client<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Context-type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain;charset=UTF-8'</span><span class="token punctuation">)</span>
  client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码可以完成数据的上报，但是会对页面跳转的流畅程度和用户体验造成影响。</p> <p>这里推荐一下 sendBeacon 方法，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">logData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span><span class="token function">senBeacon</span><span class="token punctuation">(</span><span class="token string">'/log'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>navigator.sendBeacon 天生就是来解决网页跳转时的请求发送问题的。他的几个特点决定了对应问题的解决方案：</p> <ul><li>他的行为是异步的，然就是说请求的发送不会阻塞跳转到下一个页面，因此可以保证跳转的流畅度。</li> <li>他在没有极端数据量和队列总数的限制下，会优先返回 true 以保证请求成功发送。</li></ul> <p>一般处理情况，首先通过动态创建 img 标签，以及在 img.src 中拼接参数。如果 URL 太长，就会采用 navigator.sendBeacon 方法。如果浏览器不支持该方法，则发送同步的 Ajax post。</p> <p>对 URL 长度判断代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">reportData</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>urlLength <span class="token operator">&lt;</span> <span class="token number">2083</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">imgReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> times<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>sendBeacon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">xmlLoadData</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果网页访问量很大，那么因为一个错误所发送的信息就会非常多，我们可以给错误信息的上报设置一个采集率，如下所示，采集率可以根据实际情况来设定，设定方法多种多样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">report</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只采集 30%</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="无侵入和性能友好的方案设计"><a href="#无侵入和性能友好的方案设计" class="header-anchor">#</a> 无侵入和性能友好的方案设计</h3> <p>对于一个性能监控和错误收集，设计一个好的系统方法，需要以下几个阶段：</p> <ul><li>采集</li> <li>存储</li> <li>分析过滤</li> <li>上报</li></ul> <p>下面就针对上面几个阶段核心细节相关说明一下。</p> <ol><li>数据上报优化</li></ol> <p>借助 HTTP2.0，我们可以持续优化上报性能。比如，采用 HTTP2.0 头部压缩，以减少数据传送大小；采用 HTTP2.0 多路复用技术，以充分利用链接资源。</p> <ol start="2"><li>接口和智能优化</li></ol> <p>由于线上情况复杂多样，所以我们需要选择更加智能化的方案。关于这一点,我们可以从以下几个方面考虑。</p> <ul><li>识别流量高峰和低谷时期，动态设置上报采样率。</li> <li>增强数据清洗能力，提高数据的可用性，对一些垃圾信息进行过滤。</li> <li>通过配置化，减少业务接入成本。</li> <li>如果用户一直触发错误，则系统会不停地上报相同的错误内容，这时可以考虑是否需要进行短时间滤重。</li></ul> <ol start="3"><li>实时性</li></ol> <p>目前，我们对系统数据的分析都是后置的，而如果想做到实时提醒，就要依赖后端服务，将超过阈值的情况进行邮件或短信发送。</p> <p>在这个链路中，将每个细节单独拿出来都是一个值得玩味的话题，比如，报警國值如何设定。在不同的时段和日期，应用的流量差别可能很大，比如，点评类应用或酒店预订类应用在节假日产生的流量就远远高于平时。
如果不对报警阈值做特殊处理，那么由于报警过于敏感，运维人员或发人员也许就会受到“骚扰”。业界流行 3- sigma 的阈值设置。</p> <h2 id="如何解决性能优化问题"><a href="#如何解决性能优化问题" class="header-anchor">#</a> 如何解决性能优化问题</h2> <p>前端性能优化主要分为页面工程优化代码细化两大方向。页面工程优化从页面请求开始，涉及网络协议、资源配置、浏览器性能、缓存等；代码细化优化方面的工作相对零散，比如我们要了解 JavaScript 对 DOM 的操作过程、宿主环境及单线程的相关内容等，以写出性能友好的代码。</p> <p>如果发现页面动画效果卡顿，需要从哪些角度解决问题：</p> <ul><li>一般来说，css3 动画会比基于 JavaScript 实现的动画效率更高，因此会优先使用 css3 来实现动画（这一点并不绝对）；</li> <li>在使用 css3 实现动画时，要考虑开启 GPU 加速（这一点也并不总是产生正向效果）；</li> <li>优先使用资源消耗最低的 transform 和 opacity 两个属性；</li> <li>使用 will-change 属性；</li> <li>独立合成层，减少绘制区域；</li> <li>对于只能使用 JavaScript 实现动画效果的情况，可以考虑使用 requestAnimationFrame 和 requestIdleCallback API；</li> <li>批量进行样式变换，减少布局抖动；</li></ul> <h3 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h3> <h4 id="初步解决布局抖动问题"><a href="#初步解决布局抖动问题" class="header-anchor">#</a> 初步解决布局抖动问题</h4> <p>如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>

<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>

<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight
element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
</code></pre></div><p>上面代码会造成典型的布局抖动。布局抖动是指 DOM 元素被 JavaScript 多次反复读写，导致文档多次无意义重排；我们知道浏览器很“懒”，他会合并（batch）当前操作，统一进行重排。可是，如果在当前操作完成前从 DOM 元素中获取值，那么就会迫使浏览器提早执行布局操作，这被称为强制同步布局。</p> <p>上面代码对 element1 进行读写操作后，又企图去获取 element2 的值，浏览器为了获取正确的值，只能进行重排；因此优化思路如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 读</span>
<span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight

<span class="token comment">// 写</span>
element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
</code></pre></div><h4 id="使用-window-requestanimationframe-对上面代码进行优化"><a href="#使用-window-requestanimationframe-对上面代码进行优化" class="header-anchor">#</a> 使用 window.requestAnimationFrame 对上面代码进行优化</h4> <p>window.requestAnimationFrame 该方法告诉浏览器你希望执行的操作，并请求浏览器在下一次重绘之前调用指定的函数来更新。也就是说，当你需要更新屏幕画面时就可以调用此方法。浏览器在下次重绘前会统一执行回调函数，优化方案如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们将代码中所有 DOM 的写操作放在下一帧一起执行。这样可以有效减少无意义的重排，显然效率更高。</p> <h4 id="实现-window-requestanimationframe-的-polyfill"><a href="#实现-window-requestanimationframe-的-polyfill" class="header-anchor">#</a> 实现 window.requestAnimationFrame 的 polyfill</h4> <p>代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span> window<span class="token punctuation">.</span><span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> id
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>cancelAnimationFrame<span class="token punctuation">)</span> window<span class="token punctuation">.</span><span class="token function-variable function">cancelAnimationFrame</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码按照每秒钟 60 次屏幕刷新频率。</p> <h4 id="为以下每个-li-添加点击事件"><a href="#为以下每个-li-添加点击事件" class="header-anchor">#</a> 为以下每个 li 添加点击事件</h4> <p>html 内容：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这道题主要考察是否使用了事件委托；</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementByTagName</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> liList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementByTagName</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>

  ul<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> normalizeE <span class="token operator">=</span> e <span class="token operator">||</span> window<span class="token punctuation">.</span>event
    <span class="token keyword">const</span> target <span class="token operator">=</span> normalizeE<span class="token punctuation">.</span>target <span class="token operator">||</span> normalizeE<span class="token punctuation">.</span>srcElement

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'li'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="实现节流、防抖"><a href="#实现节流、防抖" class="header-anchor">#</a> 实现节流、防抖</h4> <p>两者都不能减少事件触发，减少的是触发时回调函数的执行次数。</p> <ul><li><p>防抖：抖动现象的本质是短时间内产生了高频次触发。因此，我们可以把短时间内的多个连续调用归并为一次，也就是只触发一次回调函数；</p></li> <li><p>节流：顾名思义，就是使短时间内的函数调用以一个固定的评论（一定周期）间隔执行，这就如同水龙头开关限制出水口流量一样；</p></li></ul> <p>事件防抖：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> immediate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> arguments

    <span class="token keyword">const</span> callNow <span class="token operator">=</span> immediate <span class="token operator">&amp;</span> <span class="token operator">!</span>timeout

    timeout <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

    timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timeout <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>immediate<span class="token punctuation">)</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>节流：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> handleTime <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> arguments

    <span class="token keyword">if</span> <span class="token punctuation">(</span>handleTime <span class="token operator">-</span> startTime <span class="token operator">&gt;=</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
      startTime <span class="token operator">=</span> handleTime
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新:</span> <span class="time">3/22/2021, 4:55:28 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/note/assets/js/app.cf3e5064.js" defer></script><script src="/note/assets/js/2.bfd5325d.js" defer></script><script src="/note/assets/js/43.5187dca8.js" defer></script>
  </body>
</html>
