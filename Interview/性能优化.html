<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>性能监控和错误收集与上报 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/note/assets/css/0.styles.5e98f1a2.css" as="style"><link rel="preload" href="/note/assets/js/app.981df038.js" as="script"><link rel="preload" href="/note/assets/js/2.311cbb04.js" as="script"><link rel="preload" href="/note/assets/js/48.5e4bf413.js" as="script"><link rel="prefetch" href="/note/assets/js/10.664df595.js"><link rel="prefetch" href="/note/assets/js/100.f9bbb123.js"><link rel="prefetch" href="/note/assets/js/101.2c05313d.js"><link rel="prefetch" href="/note/assets/js/102.82f6c782.js"><link rel="prefetch" href="/note/assets/js/103.93fc677d.js"><link rel="prefetch" href="/note/assets/js/104.529f0ae0.js"><link rel="prefetch" href="/note/assets/js/105.d161bac6.js"><link rel="prefetch" href="/note/assets/js/106.4721ef1c.js"><link rel="prefetch" href="/note/assets/js/107.4453883d.js"><link rel="prefetch" href="/note/assets/js/108.36c8f3be.js"><link rel="prefetch" href="/note/assets/js/109.369a129a.js"><link rel="prefetch" href="/note/assets/js/11.01b0157b.js"><link rel="prefetch" href="/note/assets/js/110.8bfe124b.js"><link rel="prefetch" href="/note/assets/js/111.dc06980d.js"><link rel="prefetch" href="/note/assets/js/112.1f0e5417.js"><link rel="prefetch" href="/note/assets/js/113.e6187b45.js"><link rel="prefetch" href="/note/assets/js/114.9cb4ce8e.js"><link rel="prefetch" href="/note/assets/js/115.d24f7662.js"><link rel="prefetch" href="/note/assets/js/116.21685d0b.js"><link rel="prefetch" href="/note/assets/js/117.021e98f6.js"><link rel="prefetch" href="/note/assets/js/118.0b4b61b4.js"><link rel="prefetch" href="/note/assets/js/119.987461a0.js"><link rel="prefetch" href="/note/assets/js/12.42bc42e1.js"><link rel="prefetch" href="/note/assets/js/120.ade978ca.js"><link rel="prefetch" href="/note/assets/js/121.e73615a1.js"><link rel="prefetch" href="/note/assets/js/122.9eb81930.js"><link rel="prefetch" href="/note/assets/js/123.621c088f.js"><link rel="prefetch" href="/note/assets/js/124.eb851c6b.js"><link rel="prefetch" href="/note/assets/js/125.4708f471.js"><link rel="prefetch" href="/note/assets/js/126.8dff9f7e.js"><link rel="prefetch" href="/note/assets/js/127.232acd76.js"><link rel="prefetch" href="/note/assets/js/128.71d7896d.js"><link rel="prefetch" href="/note/assets/js/129.56bbf574.js"><link rel="prefetch" href="/note/assets/js/13.48279650.js"><link rel="prefetch" href="/note/assets/js/130.6300dff1.js"><link rel="prefetch" href="/note/assets/js/131.3493328c.js"><link rel="prefetch" href="/note/assets/js/132.99ae2904.js"><link rel="prefetch" href="/note/assets/js/133.fab4bb3b.js"><link rel="prefetch" href="/note/assets/js/134.43d7d1dd.js"><link rel="prefetch" href="/note/assets/js/135.b47a3b1a.js"><link rel="prefetch" href="/note/assets/js/136.6c8f2884.js"><link rel="prefetch" href="/note/assets/js/137.51766a3d.js"><link rel="prefetch" href="/note/assets/js/138.ee068b7b.js"><link rel="prefetch" href="/note/assets/js/139.7b258a1f.js"><link rel="prefetch" href="/note/assets/js/14.420e70c0.js"><link rel="prefetch" href="/note/assets/js/140.3d414796.js"><link rel="prefetch" href="/note/assets/js/141.ba09cea1.js"><link rel="prefetch" href="/note/assets/js/142.ba201a8c.js"><link rel="prefetch" href="/note/assets/js/143.c958d6b6.js"><link rel="prefetch" href="/note/assets/js/144.ed0de9ec.js"><link rel="prefetch" href="/note/assets/js/145.fccca3b5.js"><link rel="prefetch" href="/note/assets/js/146.fa1b0b68.js"><link rel="prefetch" href="/note/assets/js/147.f5341101.js"><link rel="prefetch" href="/note/assets/js/148.fe5df873.js"><link rel="prefetch" href="/note/assets/js/149.e33de248.js"><link rel="prefetch" href="/note/assets/js/15.57860ef7.js"><link rel="prefetch" href="/note/assets/js/150.90420b73.js"><link rel="prefetch" href="/note/assets/js/151.0dbef4f7.js"><link rel="prefetch" href="/note/assets/js/152.c2b4f6f9.js"><link rel="prefetch" href="/note/assets/js/153.85619705.js"><link rel="prefetch" href="/note/assets/js/154.9d3befc4.js"><link rel="prefetch" href="/note/assets/js/155.d75fc43a.js"><link rel="prefetch" href="/note/assets/js/156.d8a6589e.js"><link rel="prefetch" href="/note/assets/js/157.73f5b8cc.js"><link rel="prefetch" href="/note/assets/js/158.8fbc7a04.js"><link rel="prefetch" href="/note/assets/js/159.7cc4f914.js"><link rel="prefetch" href="/note/assets/js/16.3af552e9.js"><link rel="prefetch" href="/note/assets/js/160.94b3c8e2.js"><link rel="prefetch" href="/note/assets/js/161.f27ea88c.js"><link rel="prefetch" href="/note/assets/js/162.02af5a73.js"><link rel="prefetch" href="/note/assets/js/163.6694278d.js"><link rel="prefetch" href="/note/assets/js/164.5ebace33.js"><link rel="prefetch" href="/note/assets/js/165.b500084c.js"><link rel="prefetch" href="/note/assets/js/166.c3ebe87c.js"><link rel="prefetch" href="/note/assets/js/167.c2f1639d.js"><link rel="prefetch" href="/note/assets/js/168.3abe4b41.js"><link rel="prefetch" href="/note/assets/js/169.21048818.js"><link rel="prefetch" href="/note/assets/js/17.a20d5be0.js"><link rel="prefetch" href="/note/assets/js/170.5e2dcb37.js"><link rel="prefetch" href="/note/assets/js/171.ea57b3b6.js"><link rel="prefetch" href="/note/assets/js/172.0c382305.js"><link rel="prefetch" href="/note/assets/js/173.905ec41d.js"><link rel="prefetch" href="/note/assets/js/174.3c03479f.js"><link rel="prefetch" href="/note/assets/js/175.a06fc96d.js"><link rel="prefetch" href="/note/assets/js/176.df14a144.js"><link rel="prefetch" href="/note/assets/js/177.b0ea9d53.js"><link rel="prefetch" href="/note/assets/js/178.5be8caf4.js"><link rel="prefetch" href="/note/assets/js/179.d4b8b9a6.js"><link rel="prefetch" href="/note/assets/js/18.46dcef09.js"><link rel="prefetch" href="/note/assets/js/180.50c9974c.js"><link rel="prefetch" href="/note/assets/js/181.ede33d73.js"><link rel="prefetch" href="/note/assets/js/182.32945318.js"><link rel="prefetch" href="/note/assets/js/183.d4be1c34.js"><link rel="prefetch" href="/note/assets/js/184.82309467.js"><link rel="prefetch" href="/note/assets/js/19.e0a89ded.js"><link rel="prefetch" href="/note/assets/js/20.bad3b903.js"><link rel="prefetch" href="/note/assets/js/21.6f4a95be.js"><link rel="prefetch" href="/note/assets/js/22.4ed83a87.js"><link rel="prefetch" href="/note/assets/js/23.7529ff79.js"><link rel="prefetch" href="/note/assets/js/24.fb7f17a9.js"><link rel="prefetch" href="/note/assets/js/25.a23708f6.js"><link rel="prefetch" href="/note/assets/js/26.31121813.js"><link rel="prefetch" href="/note/assets/js/27.895c77a8.js"><link rel="prefetch" href="/note/assets/js/28.e0948a06.js"><link rel="prefetch" href="/note/assets/js/29.930561ae.js"><link rel="prefetch" href="/note/assets/js/3.d4f1f423.js"><link rel="prefetch" href="/note/assets/js/30.5050dae6.js"><link rel="prefetch" href="/note/assets/js/31.a41a7341.js"><link rel="prefetch" href="/note/assets/js/32.32493f44.js"><link rel="prefetch" href="/note/assets/js/33.de832296.js"><link rel="prefetch" href="/note/assets/js/34.9b9acc8b.js"><link rel="prefetch" href="/note/assets/js/35.0d214042.js"><link rel="prefetch" href="/note/assets/js/36.1b333ece.js"><link rel="prefetch" href="/note/assets/js/37.8fc02437.js"><link rel="prefetch" href="/note/assets/js/38.72c4e747.js"><link rel="prefetch" href="/note/assets/js/39.90902816.js"><link rel="prefetch" href="/note/assets/js/4.2819838d.js"><link rel="prefetch" href="/note/assets/js/40.6592259d.js"><link rel="prefetch" href="/note/assets/js/41.39d44063.js"><link rel="prefetch" href="/note/assets/js/42.49aad173.js"><link rel="prefetch" href="/note/assets/js/43.fbf06b60.js"><link rel="prefetch" href="/note/assets/js/44.ed98de23.js"><link rel="prefetch" href="/note/assets/js/45.d0dac465.js"><link rel="prefetch" href="/note/assets/js/46.9dc9de18.js"><link rel="prefetch" href="/note/assets/js/47.4de115b9.js"><link rel="prefetch" href="/note/assets/js/49.9b39fd3e.js"><link rel="prefetch" href="/note/assets/js/5.b2ee9f0a.js"><link rel="prefetch" href="/note/assets/js/50.54bfe53c.js"><link rel="prefetch" href="/note/assets/js/51.ae963f8e.js"><link rel="prefetch" href="/note/assets/js/52.eab5edf7.js"><link rel="prefetch" href="/note/assets/js/53.beba3081.js"><link rel="prefetch" href="/note/assets/js/54.ba9dad9b.js"><link rel="prefetch" href="/note/assets/js/55.fe20b974.js"><link rel="prefetch" href="/note/assets/js/56.a2722eaf.js"><link rel="prefetch" href="/note/assets/js/57.d1885582.js"><link rel="prefetch" href="/note/assets/js/58.0086e112.js"><link rel="prefetch" href="/note/assets/js/59.1eeb5d87.js"><link rel="prefetch" href="/note/assets/js/6.d73a81bc.js"><link rel="prefetch" href="/note/assets/js/60.da4f411e.js"><link rel="prefetch" href="/note/assets/js/61.adb78d23.js"><link rel="prefetch" href="/note/assets/js/62.8c1a8313.js"><link rel="prefetch" href="/note/assets/js/63.b007282b.js"><link rel="prefetch" href="/note/assets/js/64.aea44f73.js"><link rel="prefetch" href="/note/assets/js/65.6c92f7b7.js"><link rel="prefetch" href="/note/assets/js/66.957a0570.js"><link rel="prefetch" href="/note/assets/js/67.ed8ff64e.js"><link rel="prefetch" href="/note/assets/js/68.2fee594c.js"><link rel="prefetch" href="/note/assets/js/69.8af06e79.js"><link rel="prefetch" href="/note/assets/js/7.a5b714fc.js"><link rel="prefetch" href="/note/assets/js/70.686eeb67.js"><link rel="prefetch" href="/note/assets/js/71.3303d84c.js"><link rel="prefetch" href="/note/assets/js/72.9d15130f.js"><link rel="prefetch" href="/note/assets/js/73.c381cd57.js"><link rel="prefetch" href="/note/assets/js/74.6c9825e6.js"><link rel="prefetch" href="/note/assets/js/75.a6f40f9f.js"><link rel="prefetch" href="/note/assets/js/76.357099e7.js"><link rel="prefetch" href="/note/assets/js/77.8fe07367.js"><link rel="prefetch" href="/note/assets/js/78.eaf37c3d.js"><link rel="prefetch" href="/note/assets/js/79.c593dadc.js"><link rel="prefetch" href="/note/assets/js/8.e1d96763.js"><link rel="prefetch" href="/note/assets/js/80.912793c7.js"><link rel="prefetch" href="/note/assets/js/81.42a7e76f.js"><link rel="prefetch" href="/note/assets/js/82.830fcb74.js"><link rel="prefetch" href="/note/assets/js/83.35065763.js"><link rel="prefetch" href="/note/assets/js/84.96abab40.js"><link rel="prefetch" href="/note/assets/js/85.e73d1c35.js"><link rel="prefetch" href="/note/assets/js/86.2eb30991.js"><link rel="prefetch" href="/note/assets/js/87.218015ac.js"><link rel="prefetch" href="/note/assets/js/88.b6a04fee.js"><link rel="prefetch" href="/note/assets/js/89.ff895fb6.js"><link rel="prefetch" href="/note/assets/js/9.ad0982bc.js"><link rel="prefetch" href="/note/assets/js/90.35e4b5fb.js"><link rel="prefetch" href="/note/assets/js/91.a2b8f1a7.js"><link rel="prefetch" href="/note/assets/js/92.aaeaae28.js"><link rel="prefetch" href="/note/assets/js/93.061e2707.js"><link rel="prefetch" href="/note/assets/js/94.58e895e7.js"><link rel="prefetch" href="/note/assets/js/95.a94ffca7.js"><link rel="prefetch" href="/note/assets/js/96.ac7141ea.js"><link rel="prefetch" href="/note/assets/js/97.e470b005.js"><link rel="prefetch" href="/note/assets/js/98.0c20f597.js"><link rel="prefetch" href="/note/assets/js/99.f37558d0.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.5e98f1a2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/note/css/css基础.html" class="nav-link">
  css 相关
</a></div><div class="nav-item"><a href="/note/javascript/知识体系.html" class="nav-link">
  javascript
</a></div><div class="nav-item"><a href="/note/js-patterns/代理模式.html" class="nav-link">
  js 设计模式
</a></div><div class="nav-item"><a href="/note/webpack/基础知识.html" class="nav-link">
  webpack
</a></div><div class="nav-item"><a href="/note/vue/相关笔记.html" class="nav-link">
  vue
</a></div><div class="nav-item"><a href="/note/react/react基础.html" class="nav-link">
  react 相关
</a></div><div class="nav-item"><a href="/note/angular/基础.html" class="nav-link">
  angular
</a></div><div class="nav-item"><a href="/note/http/HTTP协议基础.html" class="nav-link">
  http
</a></div><div class="nav-item"><a href="/note/node/基础知识.html" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/typescript/typescript基础语法.html" class="nav-link">
  typescript
</a></div><div class="nav-item"><a href="/note/webgis/坐标系相关.html" class="nav-link">
  webgis
</a></div><div class="nav-item"><a href="/note/js-gc/数据类型.html" class="nav-link">
  红宝书
</a></div><div class="nav-item"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="nav-link">
  interview
</a></div><div class="nav-item"><a href="/note/gisAlgorithm/数据结构-矢量.html" class="nav-link">
  gis 算法
</a></div><div class="nav-item"><a href="/note/graphics/图形学基础.html" class="nav-link">
  图形学相关
</a></div><div class="nav-item"><a href="/note/js-algorithm/栈.html" class="nav-link">
  算法与数据结构
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html" class="sidebar-link">forEach、for in、for of、map之间的区别</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#foreach" class="sidebar-link">1️⃣ forEach</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#语法" class="sidebar-link">语法</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#参数" class="sidebar-link">参数</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#不同点" class="sidebar-link">不同点</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#for-in" class="sidebar-link">2️⃣ for...in</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#语法-2" class="sidebar-link">语法</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#遍历数组的缺点" class="sidebar-link">遍历数组的缺点</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#for-of" class="sidebar-link">3️⃣ for...of</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#语法-3" class="sidebar-link">语法</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#示例-2" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#跳出循环" class="sidebar-link">跳出循环</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#与-for-in-的区别" class="sidebar-link">与 for...in 的区别</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#map" class="sidebar-link">4️⃣ map</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#语法-4" class="sidebar-link">语法</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#参数-2" class="sidebar-link">参数</a></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#返回值" class="sidebar-link">返回值</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/forEach-forIn-forOf-map之间的区别.html#补充说明" class="sidebar-link">✏️ 补充说明</a></li></ul></li><li><a href="/note/interview/HTML中的JavaScript.html" class="sidebar-link">HTML中的JavaScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/HTML中的JavaScript.html#script-元素" class="sidebar-link">script 元素</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/HTML中的JavaScript.html#推迟执行脚本" class="sidebar-link">推迟执行脚本</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML中的JavaScript.html#异步执行脚本" class="sidebar-link">异步执行脚本</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML中的JavaScript.html#动态加载脚本" class="sidebar-link">动态加载脚本</a></li></ul></li></ul></li><li><a href="/note/interview/this详解.html" class="sidebar-link">this详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#this-指向的几条规则" class="sidebar-link">this 指向的几条规则</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#例子" class="sidebar-link">例子</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#全局环境中的-this" class="sidebar-link">全局环境中的 this</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#上下文对象调用中的-this" class="sidebar-link">上下文对象调用中的 this</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#bind、apply、call-改变-this-指向" class="sidebar-link">bind、apply、call 改变 this 指向</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#手写-bind-函数" class="sidebar-link">手写 bind 函数</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#构造函数和-this" class="sidebar-link">构造函数和 this</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#new-操作符" class="sidebar-link">new 操作符</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#箭头函数与-this" class="sidebar-link">箭头函数与 this</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#this-优先级" class="sidebar-link">this 优先级</a></li><li class="sidebar-sub-header"><a href="/note/interview/this详解.html#let、const" class="sidebar-link">let、const</a></li></ul></li></ul></li><li><a href="/note/interview/闭包.html" class="sidebar-link">闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#作用域" class="sidebar-link">作用域</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#函数参数中的暂时性死区" class="sidebar-link">函数参数中的暂时性死区</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#执行上下文和调用栈" class="sidebar-link">执行上下文和调用栈</a></li><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#作用域与执行上下文" class="sidebar-link">作用域与执行上下文</a></li><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#闭包" class="sidebar-link">闭包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#示例" class="sidebar-link">示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#内存管理" class="sidebar-link">内存管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/闭包.html#chrome-devtool-排查内存泄漏" class="sidebar-link">Chrome devtool 排查内存泄漏</a></li></ul></li></ul></li><li><a href="/note/interview/一些API的实现.html" class="sidebar-link">一些API的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#jquery-offset-方法" class="sidebar-link">jQuery offset 方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#递归实现" class="sidebar-link">递归实现</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#getboundingclientrect-实现" class="sidebar-link">getBoundingClientRect 实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#数组-reduce-方法的实现" class="sidebar-link">数组 reduce 方法的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#通过-reduce-实现-runpromiseinsequence" class="sidebar-link">通过 reduce 实现 runPromiseInSequence</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#通过-reduce-实现-pipe" class="sidebar-link">通过 reduce 实现 pipe</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#实现-reduce-方法" class="sidebar-link">实现 reduce 方法</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#koa-only-模块中的-reduce-方法" class="sidebar-link">Koa only 模块中的 reduce 方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#实现-compose-方法的几种方案" class="sidebar-link">实现 compose 方法的几种方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#面向过程的实现思路" class="sidebar-link">面向过程的实现思路</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#函数组合-reduce" class="sidebar-link">函数组合（reduce）</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#函数交织-aop-编程" class="sidebar-link">函数交织（AOP 编程）</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#promise-sequence" class="sidebar-link">Promise（sequence）</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#generator-yield" class="sidebar-link">Generator（yield）</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#loadsh-中实现-compose-方法的方案" class="sidebar-link">loadsh 中实现 compose 方法的方案</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#redux-中实现-compose-方法的方案" class="sidebar-link">Redux 中实现 compose 方法的方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#apply、bind-进阶实现" class="sidebar-link">apply、bind 进阶实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#实现-bind-函数" class="sidebar-link">实现 bind 函数</a></li><li class="sidebar-sub-header"><a href="/note/interview/一些API的实现.html#实现-apply-函数" class="sidebar-link">实现 apply 函数</a></li></ul></li></ul></li><li><a href="/note/interview/其他高频考点.html" class="sidebar-link">其他高频考点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#javascript-数据类型以及判断" class="sidebar-link">JavaScript 数据类型以及判断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#使用-typeof-判断数据类型" class="sidebar-link">使用 typeof 判断数据类型</a></li><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#使用-instanceof-判断数据类型" class="sidebar-link">使用 instanceof 判断数据类型</a></li><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#使用-constructor-和-object-prototype-tostring-判断数据类型" class="sidebar-link">使用 constructor 和 Object.prototype.toString 判断数据类型</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#javascript-数据类型及其转换" class="sidebar-link">JavaScript 数据类型及其转换</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#运算符数据类型的转换" class="sidebar-link">+ 运算符数据类型的转换</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#javascript-函数参数传递" class="sidebar-link">JavaScript 函数参数传递</a></li><li class="sidebar-sub-header"><a href="/note/interview/其他高频考点.html#cannot-read-prototype-of-undefined-问题解决方案" class="sidebar-link">cannot read prototype of undefined 问题解决方案</a></li></ul></li><li><a href="/note/interview/JavaScript中的异步.html" class="sidebar-link">JavaScript中的异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#异步-红绿灯任务控制" class="sidebar-link">异步——红绿灯任务控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#callback-方案" class="sidebar-link">callback 方案</a></li><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#promise-解决" class="sidebar-link">Promise 解决</a></li><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#async-await-解决" class="sidebar-link">async/await 解决</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#请求图片进行预先加载" class="sidebar-link">请求图片进行预先加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#settimeout-相关考察" class="sidebar-link">setTImeout 相关考察</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/JavaScript中的异步.html#宏任务和微任务" class="sidebar-link">宏任务和微任务</a></li></ul></li><li><a href="/note/interview/Promise相关.html" class="sidebar-link">Promise相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/Promise相关.html#手写-promise" class="sidebar-link">手写 Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/Promise相关.html#基础版本" class="sidebar-link">基础版本</a></li><li class="sidebar-sub-header"><a href="/note/interview/Promise相关.html#promise-穿透实现" class="sidebar-link">Promise 穿透实现</a></li><li class="sidebar-sub-header"><a href="/note/interview/Promise相关.html#promise-静态方法和其他方法实现" class="sidebar-link">Promise 静态方法和其他方法实现</a></li></ul></li></ul></li><li><a href="/note/interview/面向对象和原型.html" class="sidebar-link">面向对象和原型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#new-关键字" class="sidebar-link">new 关键字</a></li><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#实现继承" class="sidebar-link">实现继承</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#es5-中继承方案" class="sidebar-link">ES5 中继承方案</a></li><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#继承-date" class="sidebar-link">继承 Date</a></li><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#基于-es6-实现继承剖析" class="sidebar-link">基于 ES6 实现继承剖析</a></li><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#jquery-中的对象思想" class="sidebar-link">jQuery 中的对象思想</a></li><li class="sidebar-sub-header"><a href="/note/interview/面向对象和原型.html#类基础和原型继承的区别" class="sidebar-link">类基础和原型继承的区别</a></li></ul></li></ul></li><li><a href="/note/interview/ES新特性.html" class="sidebar-link">ES新特性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#object-spread-和-object-assign" class="sidebar-link">Object spread 和 Object.assign</a></li><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#箭头函数不适用的场景" class="sidebar-link">箭头函数不适用的场景</a></li><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#proxy" class="sidebar-link">Proxy</a></li><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#decorator" class="sidebar-link">Decorator</a></li><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#babel-编译" class="sidebar-link">Babel 编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#const、let-编译分析" class="sidebar-link">const、let 编译分析</a></li><li class="sidebar-sub-header"><a href="/note/interview/ES新特性.html#箭头函数的编译分析" class="sidebar-link">箭头函数的编译分析</a></li></ul></li></ul></li><li><a href="/note/interview/HTML和CSS相关.html" class="sidebar-link">HTML和CSS相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#语义化" class="sidebar-link">语义化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#语义化是什么" class="sidebar-link">语义化是什么</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#bfc-布局问题" class="sidebar-link">BFC 布局问题</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#通过多种方式实现居中" class="sidebar-link">通过多种方式实现居中</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#进击的-html" class="sidebar-link">进击的 HTML</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#web-components" class="sidebar-link">Web components</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#移动端-h5-注意事项总结" class="sidebar-link">移动端 H5 注意事项总结</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#css-变量和主题切换优雅实现" class="sidebar-link">CSS 变量和主题切换优雅实现</a></li><li class="sidebar-sub-header"><a href="/note/interview/HTML和CSS相关.html#css-modules" class="sidebar-link">CSS Modules</a></li></ul></li></ul></li><li><a href="/note/interview/响应式布局和Bootstrap的实现分析.html" class="sidebar-link">响应式布局和Bootstrap的实现分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#响应式布局适配方案" class="sidebar-link">响应式布局适配方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#线上适配案例分析" class="sidebar-link">线上适配案例分析</a></li><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#bootstrap-栅格实现思路" class="sidebar-link">Bootstrap 栅格实现思路</a></li><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#横屏适配及其他细节问题" class="sidebar-link">横屏适配及其他细节问题</a></li><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#相对于谁" class="sidebar-link">% 相对于谁</a></li><li class="sidebar-sub-header"><a href="/note/interview/响应式布局和Bootstrap的实现分析.html#深入-flex-布局和传统布局的性能对比" class="sidebar-link">深入：flex 布局和传统布局的性能对比</a></li></ul></li></ul></li><li><a href="/note/interview/框架相关.html" class="sidebar-link">框架相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#响应式框架基本原理" class="sidebar-link">响应式框架基本原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#数据劫持-数据代理" class="sidebar-link">数据劫持/数据代理</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#监听数组的变化" class="sidebar-link">监听数组的变化</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#object-defineproperty-和-proxy" class="sidebar-link">Object.defineProperty 和 Proxy</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#模板编译原理" class="sidebar-link">模板编译原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#模板编译实现" class="sidebar-link">模板编译实现</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#双向绑定实现" class="sidebar-link">双向绑定实现</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#发布-订阅模式简单应用" class="sidebar-link">发布/订阅模式简单应用</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#mvvm-融会贯通" class="sidebar-link">MVVM 融会贯通</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#虚拟-dom" class="sidebar-link">虚拟 DOM</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#虚拟-dom-diff" class="sidebar-link">虚拟 DOM diff</a></li><li class="sidebar-sub-header"><a href="/note/interview/框架相关.html#最小化差异应用" class="sidebar-link">最小化差异应用</a></li></ul></li></ul></li><li><a href="/note/interview/React相关.html" class="sidebar-link">React相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#this-setstate" class="sidebar-link">this.setState</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#promise-化" class="sidebar-link">Promise 化</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#原生事件和-react-合成事件" class="sidebar-link">原生事件和 React 合成事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#异步访问事件对象" class="sidebar-link">异步访问事件对象</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#阻止原生事件冒泡" class="sidebar-link">阻止原生事件冒泡</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#组件设计" class="sidebar-link">组件设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#组件通讯和封装" class="sidebar-link">组件通讯和封装</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#副作用和纯组件" class="sidebar-link">副作用和纯组件</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#react-component" class="sidebar-link">React Component</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#hooks" class="sidebar-link">hooks</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#usereducer-和-redux" class="sidebar-link">useReducer 和 Redux</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#react-router-dom" class="sidebar-link">react-router-dom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#路由匹配" class="sidebar-link">路由匹配</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#路由导航" class="sidebar-link">路由导航</a></li><li class="sidebar-sub-header"><a href="/note/interview/React相关.html#路由传参" class="sidebar-link">路由传参</a></li></ul></li></ul></li><li><a href="/note/interview/vue与react相关.html" class="sidebar-link">vue与react相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/vue与react相关.html#数据绑定" class="sidebar-link">数据绑定</a></li><li class="sidebar-sub-header"><a href="/note/interview/vue与react相关.html#组件化和数据流" class="sidebar-link">组件化和数据流</a></li><li class="sidebar-sub-header"><a href="/note/interview/vue与react相关.html#数据状态管理" class="sidebar-link">数据状态管理</a></li><li class="sidebar-sub-header"><a href="/note/interview/vue与react相关.html#渲染和更新" class="sidebar-link">渲染和更新</a></li></ul></li><li><a href="/note/interview/前端工程化相关.html" class="sidebar-link">前端工程化相关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#模块化" class="sidebar-link">模块化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#早期利用-javascript-特性实现的模块化阶段" class="sidebar-link">早期利用 JavaScript 特性实现的模块化阶段</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#规范化标准时代-commonjs" class="sidebar-link">规范化标准时代: CommonJS</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#规范化标准时代-amd" class="sidebar-link">规范化标准时代：AMD</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#规范化标准时代-cmd" class="sidebar-link">规范化标准时代：CMD</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#规范化标准时代-umd" class="sidebar-link">规范化标准时代：UMD</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#es-原生时代" class="sidebar-link">ES 原生时代</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#webpack" class="sidebar-link">webpack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#webpack-编译结果" class="sidebar-link">webpack 编译结果</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#webpack-工作原理" class="sidebar-link">webpack 工作原理</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#抽象语法树" class="sidebar-link">抽象语法树</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#compiler-和-compilation" class="sidebar-link">compiler 和 compilation</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#编写-webpack-loader" class="sidebar-link">编写 webpack loader</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#编写-webpack-plugin" class="sidebar-link">编写 webpack plugin</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#webpack-和-rollup" class="sidebar-link">webpack 和 Rollup</a></li><li class="sidebar-sub-header"><a href="/note/interview/前端工程化相关.html#代码规范工具" class="sidebar-link">代码规范工具</a></li></ul></li><li><a href="/note/interview/性能优化.html" class="active sidebar-link">性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#性能监控和错误收集与上报" class="sidebar-link">性能监控和错误收集与上报</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#性能监控指标" class="sidebar-link">性能监控指标</a></li><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#性能数据获取" class="sidebar-link">性能数据获取</a></li><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#错误信息收集" class="sidebar-link">错误信息收集</a></li><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#性能数据和错误信息上报" class="sidebar-link">性能数据和错误信息上报</a></li><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#无侵入和性能友好的方案设计" class="sidebar-link">无侵入和性能友好的方案设计</a></li></ul></li><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#如何解决性能优化问题" class="sidebar-link">如何解决性能优化问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/性能优化.html#实战" class="sidebar-link">实战</a></li></ul></li></ul></li><li><a href="/note/interview/编程思维和算法.html" class="sidebar-link">编程思维和算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/编程思维和算法.html#函数式" class="sidebar-link">函数式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/interview/编程思维和算法.html#柯里化分析" class="sidebar-link">柯里化分析</a></li></ul></li></ul></li><li><a href="/note/interview/网络知识.html" class="sidebar-link">网络知识</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="性能监控和错误收集与上报"><a href="#性能监控和错误收集与上报" class="header-anchor">#</a> 性能监控和错误收集与上报</h2> <h3 id="性能监控指标"><a href="#性能监控指标" class="header-anchor">#</a> 性能监控指标</h3> <p>常用指标有首次绘制(FP)时间、首次有内容绘制(FCP)时间、首次有意义绘制(FMP)时间、首屏时间、用户可交互(TT)时间。接下来分别看一看每个指标的含义。</p> <ul><li>首次绘制时间：对于应用页面，首次出现视党上不同于跳转之前内容的时间点，或者说是页面发生第一次绘制的时间点。</li> <li>首次有内容绘制时间：指浏览器完成渲染 DOM 中第一部分内容(可能是文本、图像或其他任何元素)的时间点，此时用户应该在视觉上有直观的感受。</li> <li>首次有意义绘制时间：指页面关键元素的渲染时间。这个概念并没有标准化定义，因为关键元素可以由开发者自行定义究竟什么是“有意义”的内容，只有开发者或产品经理自己了解。</li> <li>首屏时间：对于所有网页应用，这是一个非常重要的指标。用大白话来说，就是进入页面之后，应用渲染完成整个手机屏幕(未滚动之前)内容的时间。需要注意的是，业界对于这个指标其实没有确切的定论，比如，这个时间是否包含手机屏幕内图片的渲染完成时间。</li> <li>用户可交互时间：顾名思义，就是用户可以与应用进行交互的时间。一般来讲，我们认为是 Domready 的时间，因为我们通常会在这时绑定事件操作。如果页面中涉及交互的脚本没有下载完成，那么当然没有到达所谓的用户可交互时间。</li></ul> <p>这里提一下，DOMContentLoaded 与 load 事件的区别。DOMContentLoaded 指的是文档中 DOM 内容加载完毕的时间，也就是说 HTML 结构已经是完整的了。很多页面都包含图片、特殊字体、视频等其他资源，由于这些资源由网络请求获取，需要额外的网络请求；当页面所有的资源加载完毕后，load 事件才会被触发。</p> <h3 id="性能数据获取"><a href="#性能数据获取" class="header-anchor">#</a> 性能数据获取</h3> <h4 id="window-performance-强大但有缺点"><a href="#window-performance-强大但有缺点" class="header-anchor">#</a> window.performance：强大但有缺点</h4> <p>该 API 不仅能计算出页面性能相关的数据，还能计算出于页面资源加载和异步请求相关的数据。</p> <p>调用 performance.timing 会返回一个对象，这个对象包含各种页面加载和渲染的时间细节，如下：</p> <p><img src="/note/assets/img/performance.e7a2c4a8.png" alt="avatar"></p> <p>我们可以通过对上图中的信息进行计算得到以下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> window<span class="token punctuation">.</span>performance <span class="token operator">=</span> <span class="token punctuation">{</span> 
    memory<span class="token operator">:</span> <span class="token punctuation">{</span>
        usedJSHeapSize<span class="token punctuation">,</span>
        totalJSHeapSize<span class="token punctuation">,</span>
        jsHeapSizeLimit
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
 
    navigation<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 页面重定向跳转到当前页面的次数</span>
        redirectCount<span class="token punctuation">,</span>
        <span class="token comment">// 以哪种方式进入页面</span>
        <span class="token comment">// 0 正常跳转进入</span>
        <span class="token comment">// 1 window.location.reload() 重新刷新</span>
        <span class="token comment">// 2 通过浏览器历史记录，以及前进后退进入</span>
        <span class="token comment">// 255 其他方式进入</span>
        type<span class="token punctuation">,</span>         
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
 
    timing<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 等于前一个页面 unload 时间，如果没有前一个页面，则等于 fetchStart 时间</span>
        navigationStart<span class="token punctuation">,</span>
        <span class="token comment">// 前一个页面 unload 时间，如果没有前一个页面或者前一个页面与当前页面不同域，则值为 0</span>
        unloadEventStart<span class="token punctuation">,</span>
        <span class="token comment">// 前一个页面 unload 事件绑定的回调函数执行完毕的时间</span>
        unloadEventEnd<span class="token punctuation">,</span>
        redirectStart<span class="token punctuation">,</span>
        redirectEnd<span class="token punctuation">,</span>
        <span class="token comment">// 检查缓存前，准备请求第一个资源的时间</span>
        fetchStart<span class="token punctuation">,</span>
        <span class="token comment">// 域名查询开始的时间</span>
        domainLookupStart<span class="token punctuation">,</span>
        <span class="token comment">// 域名查询结束的时间</span>
        domainLookupEnd<span class="token punctuation">,</span>
        <span class="token comment">// HTTP（TCP） 开始建立连接的时间	        connectStart,</span>
        <span class="token comment">// HTTP（TCP）建立连接结束的时间</span>
        connectEnd<span class="token punctuation">,</span>
        secureConnectionStart<span class="token punctuation">,</span>
        <span class="token comment">// 连接建立完成后，请求文档开始的时间</span>
        requestStart<span class="token punctuation">,</span>
        <span class="token comment">// 连接建立完成后，文档开始返回并收到内容的时间</span>
        responseStart<span class="token punctuation">,</span>
        <span class="token comment">// 最后一个字节返回并收到内容的时间</span>
        responseEnd<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 loading 的时间</span>
        domLoading<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 interactive</span>
        domInteractive<span class="token punctuation">,</span>
        <span class="token comment">// DOMContentLoaded 事件开始时间</span>
        domContentLoadedEventStart<span class="token punctuation">,</span>
        <span class="token comment">// DOMContentLoaded 事件结束时间</span>
        domContentLoadedEventEnd<span class="token punctuation">,</span>
        <span class="token comment">// Document.readyState 值为 complete 的时间	        domComplete,</span>
        <span class="token comment">// load 事件开始的时间</span>
        loadEventStart<span class="token punctuation">,</span>
        <span class="token comment">// load 事件结束的时间</span>
        loadEventEnd
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据这些时间节点选择对应的时间两两做差，便可以计算出一些典型的指标，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">calcTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing
      
    <span class="token comment">// 重定向时间</span>
    times<span class="token punctuation">.</span>redirectTime <span class="token operator">=</span> t<span class="token punctuation">.</span>redirectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>redirectStart
      
    <span class="token comment">// DNS 查询耗时</span>
    times<span class="token punctuation">.</span>dnsTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>domainLookupStart
      
    <span class="token comment">// TCP 建立连接完成握手的时间</span>
    connect <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
      
    <span class="token comment">// TTFB 读取页面第一个字节的时间</span>
    times<span class="token punctuation">.</span>ttfbTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseStart <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart
      
    <span class="token comment">// DNS 缓存时间</span>
    times<span class="token punctuation">.</span>appcacheTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domainLookupStart <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// 卸载页面的时间</span>
    times<span class="token punctuation">.</span>unloadTime <span class="token operator">=</span> t<span class="token punctuation">.</span>unloadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>unloadEventStart
      
    <span class="token comment">// TCP 连接耗时</span>
    times<span class="token punctuation">.</span>tcpTime <span class="token operator">=</span> t<span class="token punctuation">.</span>connectEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>connectStart
      
    <span class="token comment">// request 请求耗时</span>
    times<span class="token punctuation">.</span>reqTime <span class="token operator">=</span> t<span class="token punctuation">.</span>responseEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>responseStart
      
    <span class="token comment">// 解析 DOM 树耗时</span>
    times<span class="token punctuation">.</span>analysisTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domComplete <span class="token operator">-</span> t<span class="token punctuation">.</span>domInteractive
      
    <span class="token comment">// 白屏时间</span>
    times<span class="token punctuation">.</span>blankTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domLoading <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// domReadyTime 即用户可交互时间</span>
    times<span class="token punctuation">.</span>domReadyTime <span class="token operator">=</span> t<span class="token punctuation">.</span>domContentLoadedEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>fetchStart
      
    <span class="token comment">// 用户等待页面完全可用的时间</span>
    times<span class="token punctuation">.</span>loadPage <span class="token operator">=</span> t<span class="token punctuation">.</span>loadEventEnd <span class="token operator">-</span> t<span class="token punctuation">.</span>navigationStart

    <span class="token keyword">return</span> times
<span class="token punctuation">}</span>
</code></pre></div><p>该 API 也有不适应的场景，比如在单页应用中改变 URL 但不刷新页面（单页面引用的典型路由分格方案），那么使用该 API 所获取的数据是不会更新的，还需要开发者重新设计统计方案。</p> <h4 id="自定义事件计算"><a href="#自定义事件计算" class="header-anchor">#</a> 自定义事件计算</h4> <p>对于网页高度小于屏幕的网站来说，统计首屏渲染耗时非常简单，只要在页面底部加上脚本，记录执行该脚本的时间，并将这个时间与 window.performance.timing.navigationStart 时间做差，即得到首屏渲染耗时。</p> <p>对于网页高度大于一屏的页面来说，需要先估算出接近于一个屏幕的最后一个元素的位置，然后在该位置插入下面的脚本：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
</code></pre></div><p>上面的计算方式显然是理想化的，这种方式其实并没有考虑首屏图片加载的情况，也就是说对于首屏图片未加载完的情况，我们也认为加载已经完成。如果需要考虑首屏图片的架子啊，需要使用集中化脚本统计首屏时间。通过使用定时器不断检测 img 节点，判断图片是否在首屏加载完成，找到首屏加载最慢的图片加载完成的时间，从而计算出首屏时间；如果首屏没有图片，那就使用 DOMReady 时间。计算首屏渲染耗时的相关代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getOffsetTop</span> <span class="token operator">=</span> <span class="token parameter">ele</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> offsetTop <span class="token operator">=</span> ele<span class="token punctuation">.</span>offsetTop
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span>offsetParent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offsetTop <span class="token operator">+=</span> <span class="token function">getOffsetTop</span><span class="token punctuation">(</span>ele<span class="token punctuation">.</span>offsetParent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> offsetTop
<span class="token punctuation">}</span>

<span class="token keyword">const</span> win <span class="token operator">=</span> window
<span class="token keyword">const</span> firstScreenHeight <span class="token operator">=</span> win<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height
<span class="token keyword">let</span> firstScreenImgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> isFindLastImg <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> allImgLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">let</span> collect <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> img
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isFindLastImg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstScreenImgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> firstScreenImgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                img <span class="token operator">=</span> firstScreenImgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>img<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    allImgLoaded <span class="token operator">=</span> <span class="token boolean">false</span>
                    <span class="token keyword">break</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>allImgLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            collect<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                firstScreenLoaded<span class="token operator">:</span> startTime <span class="token operator">-</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token function">clearInterval</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> imgs <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            img <span class="token operator">=</span> imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">let</span> imgOffsetTop <span class="token operator">=</span> <span class="token function">getOffsetTop</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>imgOffsetTop <span class="token operator">&gt;</span> firstScreenHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>imgOffsetTop <span class="token operator">&lt;=</span> firstScreenHeight 
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>img<span class="token punctuation">.</span>hasPushed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                img<span class="token punctuation">.</span>hasPushed <span class="token operator">=</span> <span class="token number">1</span>
                firstScreenImgs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> doc <span class="token operator">=</span> document
doc<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgs <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>imgs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

win<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    allImgLoaded <span class="token operator">=</span> <span class="token boolean">true</span>
    isFindLastImg <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>另外一种方式是不适用定时器，且默认影响首屏时间的主要因素是图片的加载，如果没有图片，那么纯粹渲染文字是很快的，因此，可以通过统计首屏内图片的加载时间获取首屏渲染完成的时间，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">logFirstScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> iLen <span class="token operator">=</span> images<span class="token punctuation">.</span>length
    <span class="token keyword">let</span> curMax <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> inScreenLen <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token comment">// 图片的加载回调</span>
    <span class="token keyword">function</span> <span class="token function">imageBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>removeEventListener
        <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> imageBack<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>curMax <span class="token operator">===</span> inScreenLen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 所有在首屏的图片均已加载完成的话，发送日志</span>
            <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>   
    <span class="token punctuation">}</span> 
    <span class="token comment">// 对于所有的位于指定区域的图片，绑定回调事件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> s <span class="token operator">&lt;</span> iLen<span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> img <span class="token operator">=</span> images<span class="token punctuation">[</span>s<span class="token punctuation">]</span>
        <span class="token keyword">var</span> offset <span class="token operator">=</span> <span class="token punctuation">{</span>
            top<span class="token operator">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> curImg <span class="token operator">=</span> img
        <span class="token keyword">while</span> <span class="token punctuation">(</span>curImg<span class="token punctuation">.</span>offsetParent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            offset<span class="token punctuation">.</span>top <span class="token operator">+=</span> curImg<span class="token punctuation">.</span>offsetTop
            curImg <span class="token operator">=</span> curImg<span class="token punctuation">.</span>offsetParent
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断图片在不在首屏</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">&lt;</span> offset<span class="token punctuation">.</span>top<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 图片还没有加载完成的话</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>img<span class="token punctuation">.</span>complete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inScreenLen<span class="token operator">++</span>
            img<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> imageBack<span class="token punctuation">,</span> <span class="token operator">!</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果首屏没有图片的话，直接发送日志</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inScreenLen <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 发送日志进行统计</span>
    <span class="token keyword">function</span> <span class="token function">log</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>logInfo<span class="token punctuation">.</span>firstScreen <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'首屏时间：'</span><span class="token punctuation">,</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> window<span class="token punctuation">.</span>performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>navigationStart<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="错误信息收集"><a href="#错误信息收集" class="header-anchor">#</a> 错误信息收集</h3> <h4 id="try-catch-方案"><a href="#try-catch-方案" class="header-anchor">#</a> try catch 方案</h4> <p>就是给每个函数进行包裹该语法，可以手动，也可以使用自动化工具，如 foio 实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">isASTFunctionNode</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Defun</span> <span class="token operator">||</span> node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Function</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">globalFuncTryCatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">inputCode<span class="token punctuation">,</span> errorHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token string">'errorHandler should be a valid function'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> errorHandlerSource <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> errorHandlerAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'('</span> <span class="token operator">+</span> errorHandlerSource <span class="token operator">+</span> <span class="token string">')(error);'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> tryCatchAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'try{}catch(error){}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> inputAST <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>inputCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> topFuncScope <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">//将错误处理函数包裹进入catch中</span>
    tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>bcatch<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> errorHandlerAST<span class="token punctuation">;</span>

    <span class="token comment">//搜集所有函数</span>
    <span class="token keyword">var</span> walker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeWalker</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isASTFunctionNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            topFuncScope<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputAST<span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>walker<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//对函数进行变换, 添加try catch语句</span>
    <span class="token keyword">var</span> transfer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeTransformer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isASTFunctionNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>topFuncScope<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//函数内部代码搜集</span>
                <span class="token keyword">var</span> stream <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">OutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">var</span> innerFuncCode <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//清除try catch中定义的多余语句</span>
                tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//用try catch包裹函数代码</span>
                <span class="token keyword">var</span> innerTyrCatchNode <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>innerFuncCode<span class="token punctuation">,</span> <span class="token punctuation">{</span>toplevel<span class="token operator">:</span> tryCatchAST<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//获取函数壳</span>
                node<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//生成有try catch的函数</span>
                <span class="token keyword">return</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>innerTyrCatchNode<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>toplevel<span class="token operator">:</span> node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputAST<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transfer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> outputCode <span class="token operator">=</span> inputAST<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">{</span>beautify<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> outputCode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>globalFuncTryCatch <span class="token operator">=</span> globalFuncTryCatch<span class="token punctuation">;</span>
</code></pre></div><p>当静态资源服务器可以添加 Access-Control-Allow-Origin: * 时，我们可以直接使用 window.onError 进行全局异常捕获；当静态资源服务器不受控制，window.onError失效，我们可以借助 AST 技术，自动化地对全部目标 Javascript 函数添加 try catch 来捕获所有异常。</p> <h4 id="try-catch-方案的局限性"><a href="#try-catch-方案的局限性" class="header-anchor">#</a> try catch 方案的局限性</h4> <p>无法处理语法错误和异步错误。如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  a <span class="token comment">// 未定义变量</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 上面代码可以捕获异常，如改为下面的语法错误就不会捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  a <span class="token operator">=</span> \ <span class="token string">'a'</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 下面异步操作无法捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果在 setTimeout 中再加一个 try catch 就可以捕获</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      a
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="window-onerror"><a href="#window-onerror" class="header-anchor">#</a> window.onerror</h4> <p>我们只需要给 window 添加 onerror 事件监听，同时注意将 window.onerror 放在所有脚本之前，便能对语法异常和运行异常进行处理，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>参数具体说明：</p> <ul><li>message：错误信息提示</li> <li>souce：错误脚本地址</li> <li>lineno：错误代码所在行号</li> <li>colno：错误代码所在列号</li> <li>error：错误的对象信息</li></ul> <p>windoe.onerror 除了对语法错误和网络错误（因为网络请求异常不会发生事件冒泡）无能为力，对异步和非异步错误都能捕获到运行时错误。</p> <p>需要注意的是，如果想用 window.onerror 函数消化错误，则需要显示返回 true，以保证错误不会向上抛出，控制台也不会出现一堆错误提示信息。</p> <h4 id="跨域脚本错误处理"><a href="#跨域脚本错误处理" class="header-anchor">#</a> 跨域脚本错误处理</h4> <p>对于不同域的 JavaScript 文件，window.onerror 不能保证获取到有效信息。出于安全原因，不同浏览器返回的错误信息参数可能并不一致。比如，跨域之后，window.onerror 在很多浏览器中是无法获取异常信息的，要统一返回脚本错误（script error），就需要对脚本进行如下设置：</p> <div class="language-js extra-class"><pre class="language-js"><code>crossorigin <span class="token operator">=</span> <span class="token string">&quot;anonymous&quot;</span>
</code></pre></div><p>同时需要在服务器端添加 Access-Control-Allow-Origin Header 内容以指定允许哪些域的请求访问。</p> <h4 id="使用-source-map-进行错误还原"><a href="#使用-source-map-进行错误还原" class="header-anchor">#</a> 使用 source map 进行错误还原</h4> <p>如果代码被压缩报错。可以启用 source map，比如在 webpack 中开启 source map 功能，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  devtool<span class="token operator">:</span> <span class="token string">'#source-map'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="promise-的错误收集与处理"><a href="#promise-的错误收集与处理" class="header-anchor">#</a> Promise 的错误收集与处理</h4> <p>Promise 主要通过 catch 进行捕获异常。可以通过 ESLint 插件 eslint-plugin-promise 插件；他会通过 catch-or-return 来保障代码中所有的 Promise 都有相应的 catch 处理。</p> <p>可能大家会想到，Promise 实例的 then 方法中的第二个 onRejected 函数也能处理错误，跟前面的 catch 有什么差别，如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'catch'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码输出 rejected，在有 onRejected 的情况下，onRejected 就会发挥作用，catch 不会被调用。</p> <p>而执行下面代码时，onRejected 并不能捕获 then 方法第一个参数 onResolved 函数中的错误：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'catch'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Error</span>
    <span class="token comment">// at &lt;anonymous&gt;:4:9 &quot;catch&quot;</span>
</code></pre></div><p>除此之外，在对 Promise 进行错误处理时，还可以捕获事件 unhandledrejection，并在此事件中集中进行错误收集，如下代码：</p> <blockquote><p>unhandledrejection: 当 Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件；这可能发生在 window 下，但也可能发生在 Worker 中。 这对于调试回退错误处理非常有用。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejectioin'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="处理网络加载问题"><a href="#处理网络加载问题" class="header-anchor">#</a> 处理网络加载问题</h4> <p>通过 script、link 标签加载脚本或者其他资源，可以通过下面代码进行异常捕获：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>***.js<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>errorHandler(this)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>***.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>errorHandler(this)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>除此之外，还可以使用 window.addEventListener('error') 方式对加载异常信息处理。注意，这时无法使用 window.onerror 进行处理，因为 window.onerror 事件通过事件冒泡获取 error 信息的，而网络加载错误是不会进行事件冒泡的。</p> <p>不支持冒泡的事件还有鼠标聚焦/失焦（focus/blur）、与鼠标移动相关的事件（mouseleave/mouseenter）、一些 UI 事件（如 scroll、resize 等）。</p> <p>window.addEventListener('error') 他是通过事件捕获获取 error 信息的，从而对网络资源的加载异常进行处理的。</p> <p>如果区分网络资源加载错误和一般错误，普通错误的 error 对象中会有一个 error.message 属性，表示错误信息，而资源加载错误对应的 error 对象却没有，因此可以根据以下代码进行区分：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 网络资源加载错误</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>window.onerror 如果多次进行函数赋值，后面赋值的会替换之前的值。window.addEventListener('error') 可以绑定多个回调函数，按照绑定顺序依次执行。</p> <h4 id="页面崩溃收集和处理"><a href="#页面崩溃收集和处理" class="header-anchor">#</a> 页面崩溃收集和处理</h4> <p>可以通过监听 window 对象的 load 和 beforeunload 事件，并结合 sessionStorage 对网页崩溃实时监控：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  sessionStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sessionStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'good_exit'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'true'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 捕获到页面崩溃</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码很简单，首先在网页加载 load 事件中设置 good_exit 状态。在页面无异常退出前，也就是 beforeunload 中设置为 true，如果该值不是 true 就会判断出页面崩溃，并进行处理。</p> <p>如果应用中部署了 PWA，这里可以通过 service worker 来完成网页崩溃的处理工作。基本原理是，service worker 和网页的主线程是相互独立的。因此即便网页发生了崩溃现象，也不会影响 service worker 所在线程的工作。我们在监控网页的状态时，是通过 navigator.serviceWorker.controller.postMessage API 来进行信息的获取和记录的。</p> <h4 id="框架的错误处理"><a href="#框架的错误处理" class="header-anchor">#</a> 框架的错误处理</h4> <p>React 在 16 版本之后使用 componentDidCatch 来处理错误，vue 中提供了 Vue.config.errorHandler 来处理捕获到的错误。如果开发者没有配置，那么捕获到的错误会以 console.error 的方式输出。因此可以劫持 console.error 来捕获框架中的错误并作出处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nativeConsoleError <span class="token operator">=</span> window<span class="token punctuation">.</span>console<span class="token punctuation">.</span>error
window<span class="token punctuation">.</span>console<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nativeConsoleError</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'I got ${args}'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="性能数据和错误信息上报"><a href="#性能数据和错误信息上报" class="header-anchor">#</a> 性能数据和错误信息上报</h3> <p>上报采用单独域名，这样做有以下好处</p> <ul><li>使用单独域名，可以防止对业务服务器造成压力，，能够避免日志相关处理逻辑和数据主业为服务器上的堆积。</li> <li>另外，很多浏览器对同一域名的请求量有并发数的限制，单独户域名能够充分利用现代浏览器的并发设置。</li></ul> <p>对于独立域名的跨域问题，我们经常发现页面使用构造空的 Image 对象的方式进行数据上报，原因是请求图片并不涉及跨域的问题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token string">'xxx'</span>
<span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> url
</code></pre></div><p>我们可以将数据进行序列化，作为 URL 参数进行传递，代码入下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">xxx?data=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> url
</code></pre></div><p>对于何时上报数据，页面加载性能数据可以在页面稳定后进行上报，对于其他错误和异常数据的上报，我们可以将日志进行合并，在同一时间统一上报。下面列出在什么场景下上报性能数据：</p> <ul><li>页面加载和重新刷新</li> <li>页面切换路由</li> <li>页面所在的 Tab 标签重新变的可见</li> <li>页面关闭</li></ul> <p>对于单页面应用就不一样了。</p> <h4 id="单应用上报"><a href="#单应用上报" class="header-anchor">#</a> 单应用上报</h4> <p>如果切换路由是通过 hash 值来实现的，那么只需要监听 hashchange 事件；如果是 history，那么需要使用 pushState 和 replaceState 事件。当然一劳永逸的做法就是打补丁，并结合发布/订阅模式为相关事件的触发添加处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">patchMethod</span> <span class="token operator">=</span> <span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> historyp<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
  <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
  event<span class="token punctuation">.</span>arguments <span class="token operator">=</span> arguments
  window<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

history<span class="token punctuation">.</span>pushState <span class="token operator">=</span> <span class="token function">patchMethod</span><span class="token punctuation">(</span><span class="token string">'pushState'</span><span class="token punctuation">)</span>
history<span class="token punctuation">.</span>replaceState <span class="token operator">=</span> <span class="token function">patchMethod</span><span class="token punctuation">(</span><span class="token string">'replaceState'</span><span class="token punctuation">)</span>
</code></pre></div><p>上面代码重写 history.pushState 和 history.replaceState 方法，添加并触发 pushState 和 replaceState 事件，可以在 history.pushState 和 history.replaceState 事件触发时添加订阅函数并进行上报：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'replaceState'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// report..</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pushState'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// report...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="非单应用上报"><a href="#非单应用上报" class="header-anchor">#</a> 非单应用上报</h4> <p>如果在页面离开时进行数据发送，那么页面卸载期间能否安全地发送完数据就是一个难题，因为在页面跳转，进入下一个页面，难以保证异步数据的安全发送。如果使用同步的 AJAX 方法，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">logData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  client<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'/log'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 第三个参数各行业表明 XHR 是同步的</span>
  client<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Context-type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain;charset=UTF-8'</span><span class="token punctuation">)</span>
  client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码可以完成数据的上报，但是会对页面跳转的流畅程度和用户体验造成影响。</p> <p>这里推荐一下 sendBeacon 方法，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> logData<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">logData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span><span class="token function">senBeacon</span><span class="token punctuation">(</span><span class="token string">'/log'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>navigator.sendBeacon 天生就是来解决网页跳转时的请求发送问题的。他的几个特点决定了对应问题的解决方案：</p> <ul><li>他的行为是异步的，然就是说请求的发送不会阻塞跳转到下一个页面，因此可以保证跳转的流畅度。</li> <li>他在没有极端数据量和队列总数的限制下，会优先返回 true 以保证请求成功发送。</li></ul> <p>一般处理情况，首先通过动态创建 img 标签，以及在 img.src 中拼接参数。如果 URL 太长，就会采用 navigator.sendBeacon 方法。如果浏览器不支持该方法，则发送同步的 Ajax post。</p> <p>对 URL 长度判断代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">reportData</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>urlLength <span class="token operator">&lt;</span> <span class="token number">2083</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">imgReport</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> times<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>sendBeacon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">xmlLoadData</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> time<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果网页访问量很大，那么因为一个错误所发送的信息就会非常多，我们可以给错误信息的上报设置一个采集率，如下所示，采集率可以根据实际情况来设定，设定方法多种多样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">report</span> <span class="token operator">=</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只采集 30%</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="无侵入和性能友好的方案设计"><a href="#无侵入和性能友好的方案设计" class="header-anchor">#</a> 无侵入和性能友好的方案设计</h3> <p>对于一个性能监控和错误收集，设计一个好的系统方法，需要以下几个阶段：</p> <ul><li>采集</li> <li>存储</li> <li>分析过滤</li> <li>上报</li></ul> <p>下面就针对上面几个阶段核心细节相关说明一下。</p> <ol><li>数据上报优化</li></ol> <p>借助 HTTP2.0，我们可以持续优化上报性能。比如，采用 HTTP2.0 头部压缩，以减少数据传送大小；采用 HTTP2.0 多路复用技术，以充分利用链接资源。</p> <ol start="2"><li>接口和智能优化</li></ol> <p>由于线上情况复杂多样，所以我们需要选择更加智能化的方案。关于这一点,我们可以从以下几个方面考虑。</p> <ul><li>识别流量高峰和低谷时期，动态设置上报采样率。</li> <li>增强数据清洗能力，提高数据的可用性，对一些垃圾信息进行过滤。</li> <li>通过配置化，减少业务接入成本。</li> <li>如果用户一直触发错误，则系统会不停地上报相同的错误内容，这时可以考虑是否需要进行短时间滤重。</li></ul> <ol start="3"><li>实时性</li></ol> <p>目前，我们对系统数据的分析都是后置的，而如果想做到实时提醒，就要依赖后端服务，将超过阈值的情况进行邮件或短信发送。</p> <p>在这个链路中，将每个细节单独拿出来都是一个值得玩味的话题，比如，报警國值如何设定。在不同的时段和日期，应用的流量差别可能很大，比如，点评类应用或酒店预订类应用在节假日产生的流量就远远高于平时。
如果不对报警阈值做特殊处理，那么由于报警过于敏感，运维人员或发人员也许就会受到“骚扰”。业界流行 3- sigma 的阈值设置。</p> <h2 id="如何解决性能优化问题"><a href="#如何解决性能优化问题" class="header-anchor">#</a> 如何解决性能优化问题</h2> <p>前端性能优化主要分为页面工程优化代码细化两大方向。页面工程优化从页面请求开始，涉及网络协议、资源配置、浏览器性能、缓存等；代码细化优化方面的工作相对零散，比如我们要了解 JavaScript 对 DOM 的操作过程、宿主环境及单线程的相关内容等，以写出性能友好的代码。</p> <p>如果发现页面动画效果卡顿，需要从哪些角度解决问题：</p> <ul><li>一般来说，css3 动画会比基于 JavaScript 实现的动画效率更高，因此会优先使用 css3 来实现动画（这一点并不绝对）；</li> <li>在使用 css3 实现动画时，要考虑开启 GPU 加速（这一点也并不总是产生正向效果）；</li> <li>优先使用资源消耗最低的 transform 和 opacity 两个属性；</li> <li>使用 will-change 属性；</li> <li>独立合成层，减少绘制区域；</li> <li>对于只能使用 JavaScript 实现动画效果的情况，可以考虑使用 requestAnimationFrame 和 requestIdleCallback API；</li> <li>批量进行样式变换，减少布局抖动；</li></ul> <h3 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h3> <h4 id="初步解决布局抖动问题"><a href="#初步解决布局抖动问题" class="header-anchor">#</a> 初步解决布局抖动问题</h4> <p>如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>

<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>

<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight
element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
</code></pre></div><p>上面代码会造成典型的布局抖动。布局抖动是指 DOM 元素被 JavaScript 多次反复读写，导致文档多次无意义重排；我们知道浏览器很“懒”，他会合并（batch）当前操作，统一进行重排。可是，如果在当前操作完成前从 DOM 元素中获取值，那么就会迫使浏览器提早执行布局操作，这被称为强制同步布局。</p> <p>上面代码对 element1 进行读写操作后，又企图去获取 element2 的值，浏览器为了获取正确的值，只能进行重排；因此优化思路如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 读</span>
<span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight

<span class="token comment">// 写</span>
element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
</code></pre></div><h4 id="使用-window-requestanimationframe-对上面代码进行优化"><a href="#使用-window-requestanimationframe-对上面代码进行优化" class="header-anchor">#</a> 使用 window.requestAnimationFrame 对上面代码进行优化</h4> <p>window.requestAnimationFrame 该方法告诉浏览器你希望执行的操作，并请求浏览器在下一次重绘之前调用指定的函数来更新。也就是说，当你需要更新屏幕画面时就可以调用此方法。浏览器在下次重绘前会统一执行回调函数，优化方案如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> h1 <span class="token operator">=</span> element1<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element1<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h1 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> h2 <span class="token operator">=</span> element2<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element2<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h2 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> h3 <span class="token operator">=</span> element3<span class="token punctuation">.</span>clientHeight
<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  element3<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token punctuation">(</span>h3 <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>我们将代码中所有 DOM 的写操作放在下一帧一起执行。这样可以有效减少无意义的重排，显然效率更高。</p> <h4 id="实现-window-requestanimationframe-的-polyfill"><a href="#实现-window-requestanimationframe-的-polyfill" class="header-anchor">#</a> 实现 window.requestAnimationFrame 的 polyfill</h4> <p>代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span> window<span class="token punctuation">.</span><span class="token function-variable function">requestAnimationFrame</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> id
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>cancelAnimationFrame<span class="token punctuation">)</span> window<span class="token punctuation">.</span><span class="token function-variable function">cancelAnimationFrame</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码按照每秒钟 60 次屏幕刷新频率。</p> <h4 id="为以下每个-li-添加点击事件"><a href="#为以下每个-li-添加点击事件" class="header-anchor">#</a> 为以下每个 li 添加点击事件</h4> <p>html 内容：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这道题主要考察是否使用了事件委托；</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementByTagName</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> liList <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementByTagName</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">)</span>

  ul<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> normalizeE <span class="token operator">=</span> e <span class="token operator">||</span> window<span class="token punctuation">.</span>event
    <span class="token keyword">const</span> target <span class="token operator">=</span> normalizeE<span class="token punctuation">.</span>target <span class="token operator">||</span> normalizeE<span class="token punctuation">.</span>srcElement

    <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'li'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="实现节流、防抖"><a href="#实现节流、防抖" class="header-anchor">#</a> 实现节流、防抖</h4> <p>两者都不能减少事件触发，减少的是触发时回调函数的执行次数。</p> <ul><li><p>防抖：抖动现象的本质是短时间内产生了高频次触发。因此，我们可以把短时间内的多个连续调用归并为一次，也就是只触发一次回调函数；</p></li> <li><p>节流：顾名思义，就是使短时间内的函数调用以一个固定的评论（一定周期）间隔执行，这就如同水龙头开关限制出水口流量一样；</p></li></ul> <p>事件防抖：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> immediate</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timeout
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> arguments

    <span class="token keyword">const</span> callNow <span class="token operator">=</span> immediate <span class="token operator">&amp;</span> <span class="token operator">!</span>timeout

    timeout <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>

    timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timeout <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>immediate<span class="token punctuation">)</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>节流：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> handleTime <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> context <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> arguments

    <span class="token keyword">if</span> <span class="token punctuation">(</span>handleTime <span class="token operator">-</span> startTime <span class="token operator">&gt;=</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
      startTime <span class="token operator">=</span> handleTime
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/interview/前端工程化相关.html" class="prev">
        前端工程化相关
      </a></span> <span class="next"><a href="/note/interview/编程思维和算法.html">
        编程思维和算法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/note/assets/js/app.981df038.js" defer></script><script src="/note/assets/js/2.311cbb04.js" defer></script><script src="/note/assets/js/48.5e4bf413.js" defer></script>
  </body>
</html>
